/*
 H5C3 Framework v0.9.7-RC1-Developer
*/
window.$DOC=function(){return window.document};window.$GEI=function(a){return $DOC().getElementById(a)};window.$CNT=function(a){return"string"===typeof a?$GEI(a):a};window.$CTX=function(a){return $CNT(a).getContext("2d")};window.$GEN=function(a){return $DOC().getElementsByName(a)};window.$GEC=function(a){return $DOC().getElementsByClass(a)};window.$ESA=function(a,b,c){$CNT(a).setAttribute(b,c)};window.$EGA=function(a,b){$CNT(a).getAttribute(b)};
window.$AEA=function(a,b,c,d){var e=$CNT(a);b=$DOC().createElement(b);c&&(b.id=c);d&&(b.innerHTML=d);e.parentNode.insertBefore(b,a);return c};window.$AET=function(a,b,c,d){a=$CNT(a);b=$DOC().createElement(b);c&&(b.id=c);d&&(b.innerHTML=d);a.appendChild(b);return b};
window.$PUW=function(a,b,c,d,e){var f=window.screen.availWidth/2-d/2,g=window.screen.availHeight/2-e/2;!0===c?(a=window.open(a,b,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no"),a.moveTo(0,0),a.resizeTo(window.screen.availWidth,window.screen.availHeight)):a=window.open(a,b,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+d+", height="+e+", top="+g+", left="+f);a&&!a.closed&&
"undefined"!==a.closed&&0!==a.screenX||window.alert("Please change your popup settings for this domain.");return a};window.$VLD=function(a){return!(null===a||"undefined"===a||void 0===a)};window.$CHK=function(a,b){return $VLD(a)?a:b};window.$AST=function(a,b){if(!a)throw b;};window.$RUN=function(a){$VLD(h5c3.bootstrap)&&h5c3.applets.use({file:a})};window.$_DBG_=function(a){(typeof h5c3.debug||typeof console)&&h5c3.debug(a)};
window.H5C3=gamecore.Base("H5C3",{NAME:"H5C3 Framework",VERSION:"0.9.7-RC1",DISTRO:"Developer",LOCATION:"http://h5c3.i2tmlabs.com/shared/",ORIENTATION:{AUTO:0,LANDSCAPE:1,PORTRAIT:2}},{debugPath:"/Android_Dev/GitHUB/com.I2TMLabs.h5c3.development/h5c3/",plugin:null,systems:null,components:null,entityFactory:null,soundFactory:null,sceneFactory:null,applets:null,devMode:!1,ready:!1,init:function(){this._super();"undefined"===typeof H5C3CFG?alert("You are trying to load the H5C3 Framework without a Configuration."):
(this.devMode="Developer"===H5C3.DISTRO||"Developer"===H5C3.DISTRO?!0:!1,this.ready=!0)},applet:function(a){},tag:function(){return H5C3.NAME+" v"+H5C3.VERSION+"-"+H5C3.DISTRO},run:function(){this.ready&&!$VLD(this.bootstrap)&&(this.bootstrap=new h5c3.Bootstrap)}});window.h5c3=new H5C3;window.h5c3.Base=gamecore.Base("h5c3.Base",{},{debug:function(a){var b=$GEI("waConsoleLog");$VLD(b)&&(b.value+=this.uniqueId+"->"+a+"\n",b.scrollTop=b.scrollHeight);window.console.log(this.uniqueId+"->"+a)}});
h5c3.Hashtable=gamecore.Hashtable;h5c3.Pool=gamecore.Pool.extend("h5c3.Pool",{},{});h5c3.Pooled=gamecore.Pooled.extend("h5c3.Pooled",{},{});h5c3.LinkedList=gamecore.LinkedList.extend("h5c3.LinkedList",{},{});h5c3.LinkedListNode=gamecore.LinkedListNode.extend("h5c3.LinkedListNode",{},{});h5c3.HashList=gamecore.HashList.extend("h5c3.HashList",{},{});h5c3.plugin=new h5c3.Hashtable;h5c3.systems=new h5c3.Hashtable;h5c3.components=new h5c3.Hashtable;
window.h5c3.GameResources=h5c3.Base.extend("h5c3.GameResources",{},{resources:null,init:function(){this._super();this.loadResources()},loadResources:function(){$_DBG_("Queing internal resources...");this.loadGraphics();this.loadAudio()},loadApplets:function(){if($VLD(window.H5C3CFG.resources)){$_DBG_("Queing application applet resources...");var a,b=window.H5C3CFG.resources.applets;for(a=0;a<b.length;++a)h5c3.loader.add(new h5c3.Applet(b[a].name,b[a].file))}else $_DBG_("No graphic resources to que. (Did you forget to add them to the config?)")},
loadGraphics:function(){if($VLD(window.H5C3CFG.resources)){$_DBG_("Queing application images resources...");var a,b=window.H5C3CFG.resources.images;for(a=0;a<b.length;++a)h5c3.loader.add(new h5c3.Image(b[a].name,b[a].file))}else $_DBG_("No graphic resources to que. (Did you forget to add them to the config?)")},loadAudio:function(){if($VLD(window.H5C3CFG.resources)){$_DBG_("Queing application audio resources...");var a,b,c,d=window.H5C3CFG.resources.sounds;for(a=0;a<d.length;a++)b="true"===d[a].ogg?
"ogg":"",c="true"===d[a].mp3?"mp3":"",h5c3.loader.add(new h5c3.Sound(d[a].name,d[a].file,[b,c],d[a].channels))}else $_DBG_("No audio resources to que. (Did you forget to add them to the config?)")}});
window.h5c3.Bootstrap=h5c3.Base.extend("h5c3.Bootstrap",{},{$baseUrl:"",$current:0,$finished:!1,$noCacheString:"",$scripts:[],init:function(){$_DBG_(h5c3.tag()+" loaded.");this.$loc=this.getFileName();this._BrowserIsChrome();this.setBaseUrl("http://h5c3.i2tmlabs.com/shared/js/ext/");$VLD(window.Modernizr)||this.add("modernizr.all.release.js");$VLD(window.jQuery)||this.add("jquery/jquery-1.10.2.min.js");$VLD(window.gamecore)||this.add("../gamecore.min.js");h5c3.devMode&&this.handleFiles();this._start()},
prepareRWD:function(){h5c3.loader=new h5c3.Loader;h5c3.stylesheet=new h5c3.StyleSheet;h5c3.resources=new h5c3.GameResources;h5c3.vars=new h5c3.HTMLVariables;h5c3.lzw=new h5c3.LZW;h5c3.loader.start();$(window).ready(function(){});$(window).resize(function(){h5c3.stylesheet.react()});$_DBG_("Rich Responsive Web Development Mode (R2WD) Ready.")},createCanvas:function(){var a=$GEI("waDIV"),b=a.clientWidth,a=a.clientHeight,c=window.H5C3CFG.screen.target.width,d=window.H5C3CFG.screen.target.height,e=$AET("waDIV",
"canvas","waCANVAS");e.style.width=b+"px";e.style.height=a+"px";e.style.minWidth=b+"px";e.style.minHeight=a+"px";e.style.maxWidth=b+"px";e.style.maxHeight=a+"px";e.width=c;e.height=d;e.style.background="Black";window.H5C3CFG.options.fullscreen?($_DBG_("OPTION: Fullscreen mode enabled."),$DOC().addEventListener("webkitfullscreenchange",h5c3.bootstrap._onFullscreenChange),e.webkitRequestFullScreen()):$_DBG_("OPTION: Fullscreen mode disabled.");return!0},handleFiles:function(){"local.html"===this.$loc?
($_DBG_("Running in Local in-house mode."),this.localLib(h5c3.debugPath+"lib/"),$VLD(window.H5C3CFG)&&(0<window.H5C3CFG.plugins.length&&this.loadPlugins(window.H5C3CFG.plugins,h5c3.debugPath+"plugins/"),0<window.H5C3CFG.applets.length&&this.loadApplets(window.H5C3CFG.applets,""),!window.H5C3CFG.rwdOnly&&0<window.H5C3CFG.files.length&&this.que(window.H5C3CFG.files,"js/"))):"debug.html"===this.$loc?($_DBG_("Running in Developer debug mode."),$VLD(window.H5C3CFG)&&(0<window.H5C3CFG.plugins.length&&this.loadPlugins(window.H5C3CFG.plugins,
H5C3.LOCATION+"plugins/"),!window.H5C3CFG.rwdOnly&&0<window.H5C3CFG.files.length&&this.que(window.H5C3CFG.files,"js/"))):"index.html"===this.$loc&&($_DBG_("Running in Production mode."),h5c3.devMode=!1,$VLD(window.H5C3CFG)&&0<window.H5C3CFG.plugins.length&&this.loadPlugins(window.H5C3CFG.plugins,H5C3.LOCATION+"plugins/"),window.H5C3CFG.rwdOnly||this.que(["game.min.js"],"js/"))},getFileName:function(){var a=document.location.href,a=a.substring(0,-1===a.indexOf("#")?a.length:a.indexOf("#")),a=a.substring(0,
-1===a.indexOf("?")?a.length:a.indexOf("?"));return a=a.substring(a.lastIndexOf("/")+1,a.length)},_onFullscreenChange:function(){var a=$GEI("waCANVAS");document.mozFullScreen||document.webkitIsFullScreen?(a.style.width=window.screen.width+"px",a.style.height=window.screen.height+"px"):(a.style.width=window.H5C3CFG.screen.width+"px",a.style.height=window.H5C3CFG.screen.height+"px")},_BrowserIsChrome:function(){var a=/chrome/.test(window.navigator.userAgent.toLowerCase()),b=$GEI("playnow"),c=$GEI("cantplay");
null!=b&&null!=c&&(a?(b.style.display="block",c.style.display="none"):(b.style.display="none",c.style.display="block"))},setDisableCache:function(){this.$noCacheString="?nocache="+Date.now()},setBaseUrl:function(a){this.$baseUrl=a},_makeUrl:function(a){return this.$baseUrl+a+this.$noCacheString},add:function(a){this.$scripts.push(this._makeUrl(a))},_start:function(){$_DBG_("Loading source files...");this.$current=0;this._loadNextScript()},_loadNextScript:function(){var a=this.$scripts[this.$current],
b=window.document.createElement("script");b.type="application/javascript";b.src=a;b.async=!1;$VLD(a)&&(b.onload=function(){h5c3.bootstrap._checkAllDone()},b.onerror=function(){throw"h5c3.bootstrap::_loadNextScript() - Could not load javascript file: "+b.src;},window.document.getElementsByTagName("head")[0].appendChild(b))},finalize:function(){this.createCanvas()?(h5c3.device=new h5c3.Device,$_DBG_("CloudApp Mode Ready."),h5c3.device.boot()):$_DBG_("ERROR: Something went wrong with preparing the canvas. Do you have a DIV with the ID of waCANVAS in your document?")},
_checkAllDone:function(){this.$finished||(this.$scripts.length-1===this.$current?($VLD(window.Modernizr)&&$_DBG_("Modernizr v"+window.Modernizr._version+" detected."),$VLD(window.jQuery)&&$_DBG_("jQuery v"+$().jquery+" detected."),this.prepareRWD(),this.$finished=!0,$VLD(window.H5C3CFG.rwdOnly)&&!1==window.H5C3CFG.rwdOnly&&this.finalize(),$_DBG_("H5C3 Framework successfully loaded.")):(this.$current++,this._loadNextScript()))},que:function(a,b){$_DBG_("que("+b+")");var c=0;this.setBaseUrl(b);for(c=
0;c<a.length;c++)this.add(a[c])},localLib:function(a){$_DBG_("Loading local framework source files...");this.setBaseUrl(a);this.add("ext/base64.js");this.add("ext/string.js");this.add("engine/media.js");this.add("engine/input.js");this.add("engine/tools.js");this.add("engine/loader.js");this.add("engine/dataresource.js");this.add("engine/math.js");this.add("engine/accutimer.js");this.add("engine/hashmap.js");this.add("engine/systems.js");this.add("engine/plugin.js");this.add("engine/device.js");this.add("r2wd/HTMLVariable.js");
this.add("r2wd/google.js");this.add("r2wd/h5c3.rwd.style.js");this.add("r2wd/segment.js");this.add("r2wd/applet.js");this.add("r2wd/lzw.js");this.add("r2wd/mapdom.js");this.add("framework/color.js");this.add("framework/factory.js");this.add("framework/banners.js");this.add("framework/main.js");this.add("framework/game.js");this.add("framework/page.js");this.add("framework/image.js");this.add("framework/scene.js");this.add("framework/sprite.js");this.add("framework/spritesheet.js");this.add("framework/entity.js");
this.add("framework/layer.js");this.add("framework/sound.js");this.add("framework/entitylayer.js");this.add("framework/intro.js")},loadApplets:function(a,b){$_DBG_("loadApplets("+window.H5C3CFG.options.path+")");var c=0;this.setBaseUrl(window.H5C3CFG.options.path);for(c=0;c<a.length;c++){var d=window.document.createElement("script");d.type="application/javascript";d.id=a[c].name;d.src=a[c].file;d.title="APPLET";d.async=!1;window.document.getElementsByTagName("head")[0].appendChild(d)}},loadPlugins:function(a,
b){$_DBG_("loadPlugins("+b+")");var c=0;this.setBaseUrl(b);for(c=0;c<a.length;c++)this.add(a[c]+".js")}});h5c3.run();
var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c,d,e,f,g,h,l=0;for(a=Base64._utf8_encode(a);l<a.length;)c=a.charCodeAt(l++),d=a.charCodeAt(l++),e=a.charCodeAt(l++),f=c>>2,c=(c&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),b=b+this._keyStr.charAt(f)+this._keyStr.charAt(c)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return b},decode:function(a){var b=[],c,d,e,f,g,h=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");h<
a.length;)c=this._keyStr.indexOf(a.charAt(h++)),d=this._keyStr.indexOf(a.charAt(h++)),f=this._keyStr.indexOf(a.charAt(h++)),g=this._keyStr.indexOf(a.charAt(h++)),c=c<<2|d>>4,d=(d&15)<<4|f>>2,e=(f&3)<<6|g,b.push(String.fromCharCode(c)),64!=f&&b.push(String.fromCharCode(d)),64!=g&&b.push(String.fromCharCode(e));b.join("");return b},_utf8_encode:function(a){if(null===a||"undefined"===typeof a)return"";a+="";var b="",c,d,e=0;c=d=0;for(var e=a.length,f=0;f<e;f++){var g=a.charCodeAt(f),h=null;128>g?d++:
h=127<g&&2048>g?String.fromCharCode(g>>6|192,g&63|128):String.fromCharCode(g>>12|224,g>>6&63|128,g&63|128);null!==h&&(d>c&&(b+=a.slice(c,d)),b+=h,c=d=f+1)}d>c&&(b+=a.slice(c,e));return b},_utf8_decode:function(a){var b=[],c=0,d=0,e=0,f=0,g=0;for(a+="";c<a.length;)e=a.charCodeAt(c),128>e?(b[d++]=String.fromCharCode(e),c++):191<e&&224>e?(f=a.charCodeAt(c+1),b[d++]=String.fromCharCode((e&31)<<6|f&63),c+=2):(f=a.charCodeAt(c+1),g=a.charCodeAt(c+2),b[d++]=String.fromCharCode((e&15)<<12|(f&63)<<6|g&63),
c+=3);return b.join("")}};
gamecore.Media=gamecore.Base.extend("gamecore.Media",{browser:{name:"Unknown",version:"Unknown"},OS:{name:"Unknown",version:"Unknown"},init:function(){this.browser.name=this.searchString(this.dataBrowser)||"Unknown";this.browser.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"Unknown";this.OS.name=this.searchString(this.dataOS)||"Unknown";this.OS.version=this.searchString(this.dataOS)||"Unknown"},searchString:function(a){for(var b=0;b<a.length;b++){var c=
a[b].string,d=a[b].prop;this.versionSearchString=a[b].versionSearch||a[b].identity;if(c){if(-1!=c.indexOf(a[b].subString))return a[b].identity}else if(d)return a[b].identity}},searchVersion:function(a){var b=a.indexOf(this.versionSearchString);if(-1!=b)return parseFloat(a.substring(b+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,
subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",
identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"},{prop:window.opera,identity:"Opera"}],dataOS:[{string:navigator.platform,subString:"Win64",identity:"Windows 64Bit"},{string:navigator.platform,subString:"WOW64",identity:"Windows 64Bit"},{string:navigator.platform,subString:"Win32",identity:"Windows 32Bit"},{string:navigator.platform,subString:"x86_64",identity:"Windows 64Bit"},{string:navigator.platform,subString:"x86-64",
identity:"Windows 64Bit"},{string:navigator.platform,subString:"x64;",identity:"Windows 64Bit"},{string:navigator.platform,subString:"x64_64",identity:"Windows 64Bit"},{string:navigator.platform,subString:"Win64",identity:"Windows 64Bit"},{string:navigator.platform,subString:"Mac",identity:"Macintosh"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"},{string:navigator.platform,subString:"Android",identity:"Android"}]},
{});
h5c3.Input=h5c3.Base("h5c3.Input",{_eventPos:null,getEventPosition:function(a,b){null===this._eventPos&&(this._eventPos=h5c3.Point.create(0,0));var c=b;$VLD(b)||(c=this._eventPos);a.pageX||a.pageY?(c.x=a.pageX,c.y=a.pageY):(c.x=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c.y=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);return c}},{stateBindings:null,states:null,actionBindings:null,mousePos:null,mouseLeftButtonDown:!1,mouseRightButtonDown:!1,mouseMiddleButtonDown:!1,
init:function(){this._super();this.stateBindings=new h5c3.Hashtable;this.states=new h5c3.Hashtable;this.actionBindings=new h5c3.Hashtable;this.mousePos=h5c3.Point.create(0,0)},bindState:function(a,b,c,d){if(null===a.uniqueId)throw"Oops, you can't bind a state to an object if it doesn't have a uniqueId function";c=c.toUpperCase();d={stateName:b,object:a,input:c,state:{on:!1,event:null},uiTarget:d};var e=this.stateBindings.get(c);null===e?this.stateBindings.put(c,[d]):e.push(d);this.states.put(a.uniqueId+
"\\\\"+b,{on:!1,event:null});h5c3.InputType.isPositional(h5c3.InputType.getCode(c))&&this._positionals.push(d)},clearStates:function(a){var b,c,d,e,f,g=this.stateBindings.entries();for(b=0;b<g.length;b++)for(f=g[b],c=0;c<f.length;c++)d=f[c],d.object===a&&(e=this.states.get(next.object.uniqueId+"\\\\"+next.stateName),e.on=!1,e.event=null,h5c3.InputType.isPositional(d.input)&&h5c3.tools.arrayRemove(this._positionals,d))},isInputState:function(a,b){var c=this.states.get(a.uniqueId+"\\\\"+b);if(null===
c)throw"Ooops, unknown state "+b;return c.on},getInputState:function(a,b){return this.states.get(a.uniqueId+"\\\\"+b)},bindAction:function(a,b,c,d){c=c.toUpperCase();var e=this.actionBindings.get(c);null===e?this.actionBindings.put(c,[{actionName:b,object:a,input:c,uiTarget:d}]):e.push({actionName:b,input:c,object:a,uiTarget:d})},fireAction:function(a,b){var c,d,e,f,g,h=this.actionBindings.get(h5c3.InputType.getName(a));if(null===h)return!1;for(c=0;c<h.length;c++)if(d=h[c],e=h[c].object,!e.isActive||
e.isActive())if(h5c3.InputType.isPositional(a)){if(f=this.Class.getEventPosition(b),(g=$VLD(d.uiTarget)?d.uiTarget.getScreenRect():e.getScreenRect?e.getScreenRect():null)&&g.containsPoint(f))e.onAction(d.actionName,b,f,d.uiTarget)}else e.onAction(d.actionName);return!0},_onReady:function(){$_DBG_("onReady Event.");h5c3.device.game.obj.attachTouchEvents(this);window.addEventListener("keydown",this._keyDown.bind(this),!0);window.addEventListener("keyup",this._keyUp.bind(this),!0)},_positionals:[],_checkPositional:function(a){var b,
c,d;for(b=0;b<this._positionals.length;b++)(c=this._positionals[b],"mousemove"===a.type&&h5c3.InputType.isTouch(h5c3.InputType.getCode(c.input))||("touchmove"===a.type&&!h5c3.InputType.isTouch(h5c3.InputType.getCode(c.input))||h5c3.InputType.getCode(c.input)===h5c3.InputType.MOUSE_BUTTON_LEFT_UP||h5c3.InputType.getCode(c.input)===h5c3.InputType.MOUSE_BUTTON_LEFT_DOWN||h5c3.InputType.getCode(c.input)===h5c3.InputType.MOUSE_BUTTON_RIGHT_UP||h5c3.InputType.getCode(c.input)===h5c3.InputType.MOUSE_BUTTON_RIGHT_DOWN||
h5c3.InputType.getCode(c.input)===h5c3.InputType.MOUSE_BUTTON_MIDDLE_UP||h5c3.InputType.getCode(c.input)===h5c3.InputType.MOUSE_BUTTON_MIDDLE_DOWN||h5c3.InputType.getCode(c.input)===h5c3.InputType.MOUSE_CLICK)||!(d=$VLD(c.uiTarget)?c.uiTarget.getScreenRect():c.object.getScreenRect?c.object.getScreenRect():null))||(d.containsPoint(this.Class.getEventPosition(a))?(c=this.states.get(c.object.uniqueId+"\\\\"+c.stateName),c.on=!0):(c=this.states.get(c.object.uniqueId+"\\\\"+c.stateName),c.on=!1),c.event=
a)},_changeState:function(a,b,c){var d,e,f,g,h;d=h5c3.InputType.getName(a);if(null===d)return this.warn("Unknown keycode = "+a),!1;e=this.stateBindings.get(d);if(null===e)return!1;for(d=0;d<e.length;d++)if(f=e[d],!f.object.isActive||f.object.isActive())h5c3.InputType.isPositional(a)?(g=this.Class.getEventPosition(c),(h=$VLD(f.uiTarget)?f.uiTarget.getScreenRect():f.object.getScreenRect?f.object.getScreenRect():null)?h.containsPoint(g)&&(f=this.states.get(f.object.uniqueId+"\\\\"+f.stateName),f.on=
b,f.event=c):(f=this.states.get(f.object.uniqueId+"\\\\"+f.stateName),f.on=b,f.event=c)):(f=this.states.get(f.object.uniqueId+"\\\\"+f.stateName),f.on=b,f.event=c);return!0},_lastMouseMove:null,process:function(){this._lastMouseMove&&(this._checkPositional(this._lastMouseMove),this.fireAction(h5c3.InputType.MOUSE_MOVE,this._lastMouseMove),this.Class.getEventPosition(this._lastMouseMove,this.mousePos),this._lastMouseMove=null)},_keyDown:function(a){this._changeState(a.keyCode,!0,a)&&a.preventDefault();
this.fireAction(a.keyCode,a)&&a.preventDefault()},_keyUp:function(a){this._changeState(a.keyCode,!1,a)&&a.preventDefault()},_touchStart:function(a){var b;b=0;for(len=a.touches.length;b<len;b++)this._changeState(h5c3.InputType.TOUCH,!0,a.touches[b]),this.fireAction(h5c3.InputType.TOUCH,a.touches[b]);a.preventDefault()},_touchEnd:function(a){var b;b=0;for(len=a.changedTouches.length;b<len;b++)this._changeState(h5c3.InputType.TOUCH,!1,a.changedTouches[b]);a.preventDefault()},_touchMove:function(a){var b;
b=0;for(len=a.touches.length;b<len;b++)this._checkPositional(a.touches[b]);a.preventDefault()},_mouseButton:function(a,b){switch(a.button){case 0:this._changeState(h5c3.InputType.MOUSE_BUTTON_LEFT_DOWN,b,a);this._changeState(h5c3.InputType.MOUSE_BUTTON_LEFT_UP,!b,a);this.fireAction(h5c3.InputType.MOUSE_BUTTON_LEFT_DOWN,a);this.mouseLeftButtonDown=!0;break;case 1:this._changeState(h5c3.InputType.MOUSE_BUTTON_MIDDLE_DOWN,b,a);this._changeState(h5c3.InputType.MOUSE_BUTTON_MIDDLE_UP,!b,a);this.fireAction(h5c3.InputType.MOUSE_BUTTON_MIDDLE_DOWN,
a);this.mouseMiddleButtonDown=!0;break;case 2:this._changeState(h5c3.InputType.MOUSE_BUTTON_RIGHT_DOWN,b,a),this._changeState(h5c3.InputType.MOUSE_BUTTON_RIGHT_UP,!b,a),this.fireAction(h5c3.InputType.MOUSE_BUTTON_RIGHT_DOWN,a),this.mouseRightButtonDown=!0}this.fireAction(h5c3.InputType.MOUSE_CLICK,a);a.preventDefault()},_mouseUp:function(a){this._mouseButton(a,!1)},_mouseDown:function(a){this._mouseButton(a,!0)},_mouseMove:function(a){this._lastMouseMove=a;a.preventDefault()},_contextMenu:function(a){this._changeState(h5c3.InputType.MOUSE_BUTTON_RIGHT_UP,
!0,a);this.fireAction(h5c3.InputType.MOUSE_BUTTON_RIGHT_DOWN,a)},_mouseWheel:function(a){0<a.wheelDelta?this.fireAction(h5c3.InputType.MOUSE_WHEEL_UP,a):this.fireAction(h5c3.InputType.MOUSE_WHEEL_DOWN,a);a.preventDefault()}});
h5c3.InputType=h5c3.Base.extend("h5c3.InputType",{nameToCode:null,codeToName:null,POSITIONAL_EVENT_START:1E3,MOUSE_MOVE:1100,MOUSE_CLICK:1110,MOUSE_BUTTON_LEFT_UP:1200,MOUSE_BUTTON_LEFT_DOWN:1201,MOUSE_BUTTON_RIGHT_UP:1220,MOUSE_BUTTON_RIGHT_DOWN:1221,MOUSE_BUTTON_MIDDLE_UP:1230,MOUSE_BUTTON_MIDDLE_DOWN:1231,MOUSE_WHEEL_UP:1300,MOUSE_WHEEL_DOWN:1301,TOUCH:1E3,TOUCH_MOVE:1001,TOUCH_START:1002,TOUCH_END:1003,TOUCH_CANCEL:1004,TOUCH_LEAVE:1005,init:function(){var a,b;this.nameToCode=new h5c3.Hashtable;
this.codeToName=new h5c3.Hashtable;this.addInput(8,"BACKSPACE");this.addInput(9,"TAB");this.addInput(13,"ENTER");this.addInput(16,"SHIFT");this.addInput(17,"CTRL");this.addInput(18,"ALT");this.addInput(19,"PAUSE");this.addInput(20,"CAPS");this.addInput(27,"ESC");this.addInput(32,"SPACE");this.addInput(33,"PAGE_UP");this.addInput(34,"PAGE_DOWN");this.addInput(35,"END");this.addInput(36,"HOME");this.addInput(37,"LEFT");this.addInput(38,"UP");this.addInput(39,"RIGHT");this.addInput(40,"DOWN");this.addInput(45,
"INSERT");this.addInput(46,"DELETE");for(a=48;91>a;a++)b=String.fromCharCode(a),this.addInput(a,b);this.addInput(91,"WINDOW_LEFT");this.addInput(92,"WINDOW_RIGHT");this.addInput(93,"SELECT");this.addInput(96,"NUM_0");this.addInput(97,"NUM_1");this.addInput(98,"NUM_2");this.addInput(99,"NUM_3");this.addInput(100,"NUM_4");this.addInput(101,"NUM_5");this.addInput(102,"NUM_6");this.addInput(103,"NUM_7");this.addInput(104,"NUM_8");this.addInput(105,"NUM_9");this.addInput(106,"*");this.addInput(107,"+");
this.addInput(109,"-");this.addInput(110,".");this.addInput(111,"/");this.addInput(112,"F1");this.addInput(113,"F2");this.addInput(114,"F3");this.addInput(115,"F4");this.addInput(116,"F5");this.addInput(117,"F6");this.addInput(118,"F7");this.addInput(119,"F8");this.addInput(120,"F9");this.addInput(121,"F10");this.addInput(122,"F11");this.addInput(123,"F12");this.addInput(144,"NUM_LOCK");this.addInput(145,"SCROLL_LOCK");this.addInput(186,";");this.addInput(187,"=");this.addInput(188,",");this.addInput(189,
"-");this.addInput(190,".");this.addInput(191,"/");this.addInput(192,"`");this.addInput(219,"[");this.addInput(220,"\\");this.addInput(221,"]");this.addInput(222,"'");this.addInput(this.TOUCH,"TOUCH");this.addInput(this.MOUSE_BUTTON_LEFT_DOWN,"MOUSE_BUTTON_LEFT_DOWN");this.addInput(this.MOUSE_BUTTON_LEFT_UP,"MOUSE_BUTTON_LEFT_UP");this.addInput(this.MOUSE_BUTTON_RIGHT_DOWN,"MOUSE_BUTTON_RIGHT_DOWN");this.addInput(this.MOUSE_BUTTON_RIGHT_UP,"MOUSE_BUTTON_RIGHT_UP");this.addInput(this.MOUSE_BUTTON_MIDDLE_DOWN,
"MOUSE_BUTTON_MIDDLE_DOWN");this.addInput(this.MOUSE_BUTTON_MIDDLE_UP,"MOUSE_BUTTON_MIDDLE_UP");this.addInput(this.MOUSE_WHEEL_UP,"MOUSE_WHEEL_UP");this.addInput(this.MOUSE_WHEEL_DOWN,"MOUSE_WHEEL_DOWN");this.addInput(this.MOUSE_MOVE,"MOUSE_MOVE");this.addInput(this.MOUSE_CLICK,"MOUSE_CLICK")},isTouch:function(a){return a===this.TOUCH},isPositional:function(a){return a>=this.POSITIONAL_EVENT_START},addInput:function(a,b){this.codeToName.put(a,b);this.nameToCode.put(b,a)},getName:function(a){return this.codeToName.get(a)},
getCode:function(a){return this.nameToCode.get(a)}},{});
h5c3.Tools=h5c3.Base.extend("h5c3.Tools",{arrayRemove:function(a,b){for(var c=a.length-1;0<=c;c--)a[c]==b&&a.splice(c,1)},arrayExclusiveAdd:function(a,b){-1==a.indexOf(b)&&a.push(b)},xmlToJson:function(a,b){var c={toObj:function(a){var b={};if(1==a.nodeType){if(a.attributes.length)for(var d=0;d<a.attributes.length;d++)b[a.attributes[d].nodeName]=(a.attributes[d].nodeValue||"").toString();if(a.firstChild){for(var h=d=0,l=!1,k=a.firstChild;k;k=k.nextSibling)1==k.nodeType?l=!0:3==k.nodeType&&k.nodeValue.match(/[^ \f\n\r\t\v]/)?
d++:4==k.nodeType&&h++;if(l)if(2>d&&2>h)for(c.removeWhite(a),k=a.firstChild;k;k=k.nextSibling)3==k.nodeType?b["#text"]=c.escape(k.nodeValue):4==k.nodeType?b["#cdata"]=c.escape(k.nodeValue):b[k.nodeName]?b[k.nodeName]instanceof Array?b[k.nodeName][b[k.nodeName].length]=c.toObj(k):b[k.nodeName]=[b[k.nodeName],c.toObj(k)]:b[k.nodeName]=c.toObj(k);else a.attributes.length?b["#text"]=c.escape(c.innerXml(a)):b=c.escape(c.innerXml(a));else if(d)a.attributes.length?b["#text"]=c.escape(c.innerXml(a)):b=c.escape(c.innerXml(a));
else if(h)if(1<h)b=c.escape(c.innerXml(a));else for(k=a.firstChild;k;k=k.nextSibling)b["#cdata"]=c.escape(k.nodeValue)}a.attributes.length||a.firstChild||(b=null)}else 9==a.nodeType?b=c.toObj(a.documentElement):alert("unhandled node type: "+a.nodeType);return b},toJson:function(a,b,d){var h=b?'"'+b+'"':"";if(a instanceof Array){for(var l=0,k=a.length;l<k;l++)a[l]=c.toJson(a[l],"",d+"\t");h+=(b?":[":"[")+(1<a.length?"\n"+d+"\t"+a.join(",\n"+d+"\t")+"\n"+d:a.join(""))+"]"}else if(null==a)h+=(b&&":")+
"null";else if("object"==typeof a){l=[];for(k in a)l[l.length]=c.toJson(a[k],k,d+"\t");h+=(b?":{":"{")+(1<l.length?"\n"+d+"\t"+l.join(",\n"+d+"\t")+"\n"+d:l.join(""))+"}"}else h="string"==typeof a?h+((b&&":")+'"'+a.toString()+'"'):h+((b&&":")+a.toString());return h},innerXml:function(a){var b="";if("innerHTML"in a)b=a.innerHTML;else{var c=function(a){var b="";if(1==a.nodeType){for(var b=b+("<"+a.nodeName),d=0;d<a.attributes.length;d++)b+=" "+a.attributes[d].nodeName+'="'+(a.attributes[d].nodeValue||
"").toString()+'"';if(a.firstChild){b+=">";for(d=a.firstChild;d;d=d.nextSibling)b+=c(d);b+="</"+a.nodeName+">"}else b+="/>"}else 3==a.nodeType?b+=a.nodeValue:4==a.nodeType&&(b+="<![CDATA["+a.nodeValue+"]]\x3e");return b};for(a=a.firstChild;a;a=a.nextSibling)b+=c(a)}return b},escape:function(a){return a.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(a){a.normalize();for(var b=a.firstChild;b;)if(3==b.nodeType)if(b.nodeValue.match(/[^ \f\n\r\t\v]/))b=
b.nextSibling;else{var d=b.nextSibling;a.removeChild(b);b=d}else 1==b.nodeType&&c.removeWhite(b),b=b.nextSibling;return a}};9==a.nodeType&&(a=a.documentElement);var d=c.toJson(c.toObj(c.removeWhite(a)),a.nodeName,"\t");return"{\n"+b+(b?d.replace(/\t/g,b):d.replace(/\t|\n/g,""))+"\n}"}},{});h5c3.tools=new h5c3.Tools;
h5c3.Loader=h5c3.Base.extend("h5c3.Loader",{},{State:{QUEUED:0,LOADING:1,READY:2,FAILED:3},timer:null,resources:new h5c3.Hashtable,loadingListener:null,loadedListener:null,progress:0,totalBeingLoaded:0,errored:0,baseUrl:"",times:{start:0,end:0,lapsed:0},started:!1,finished:!0,_noCacheString:"",init:function(){this._super();$_DBG_("Loader timer started.");this.timer=new h5c3.AccuTimer(-1,0.5,function(a,b,c){h5c3.loader.start()},function(){$_DBG_("Loader timer stopped.")})},setDisableCache:function(){this._noCacheString=
"?nocache="+Date.now()},setBaseUrl:function(a){this.baseUrl=a},setListener:function(a,b){this.loadingListener=a;this.loadedListener=b},loadFile:function(a){var b=null,c=a.substr(a.lastIndexOf(".")+1);"js"===c?(b=document.createElement("script"),b.setAttribute("type","text/javascript"),b.setAttribute("src",a)):"css"===c?(b=document.createElement("link"),b.setAttribute("rel","stylesheet"),b.setAttribute("type","text/css"),b.setAttribute("href",a)):"html"===c&&(b=document.createElement("applet"),b.setAttribute("type",
"text/html"),b.setAttribute("href",a));"undefined"!==b&&document.getElementsByTagName("head")[0].appendChild(b)},add:function(a){a.name=a.name.toLowerCase();this.resources.put(a.name.toLowerCase(),{resource:a,state:this.State.QUEUED});!0===h5c3.devMode&&$_DBG_("Adding resource "+a.src+" to the queue.")},get:function(a){var b=this.resources.get(a.toLowerCase());$VLD(b)||(this.error(this.uniqueId+"Unable to get resource "+a+". Did you forget to add it to the config?"),b=null);return b},getAllSounds:function(){var a=
[],b=this.resources.keys(),c,d;for(c=0;c<b.length;c++)d=this.resources.get(b[c]).resource,d.Class.isA("h5c3.Sound")&&a.push(d);return a},getAllImages:function(){var a=[],b=this.resources.keys(),c,d;for(c=0;c<b.length;c++)d=this.resources.get(b[c]),d.isA("h5c3.Image")&&a.push(d);return a},start:function(a,b){if(!this.started){this.started=!0;this.times.start=(new Date).getTime();var c,d,e;this.setListener(a,b);this.errored=this.progress=0;d=this.resources.keys();for(c=0;c<d.length;c++)e=this.resources.get(d[c]),
e.state===this.State.QUEUED&&(e.resource.load(this._onLoad.bind(this),this._onError.bind(this)),e.state=this.State.LOADING,this.totalBeingLoaded++);h5c3.devMode&&$_DBG_("Loading "+this.totalBeingLoaded+" resource(s).")}},makeUrl:function(a){return this.baseUrl+a+this._noCacheString},_onLoad:function(a){var b=this.resources.get(a.name);$VLD(b)?(b.state=this.State.READY,this.progress++,$VLD(this.loadingListener)&&this.loadingListener(Math.round(100*(this.progress/this.totalBeingLoaded))),!0===h5c3.devMode&&
$_DBG_(a.Class.shortName+" - "+a.name+" loaded ("+Math.round(100*(this.progress/this.totalBeingLoaded))+"% done)")):this.error("Unable to get resource ["+a.name+"] - Please make sure you are using all lowercase.");this._checkAllDone()},_onError:function(a){this.resources.get(a.name).state=this.State.FAILED;this.progress++;this.errored++;$VLD(this.loadingListener)&&this.loadingListener(this.progress/this.totalBeingLoaded);this.warn(a.name+" ("+a.src+") failed.");this._checkAllDone()},_checkAllDone:function(){this.progress>=
this.totalBeingLoaded&&(this.times.end=(new Date).getTime(),this.times.lapsed=this.times.start-this.times.end,this.finished=!0,this.started=!1,$VLD(this.loadedListener)&&this.loadedListener(this.progress,this.errored),$_DBG_("Resource Loader idle."),this.totalBeingLoaded=this.errored=this.progress=0)}});
h5c3.DataResource=h5c3.Base.extend("h5c3.DataResource",{},{data:null,request:null,src:null,name:null,loaded:!1,onLoadCallback:null,onErrorCallback:null,init:function(a,b,c,d){this._super();this.src=h5c3.loader.makeUrl(b);this.name=a;this.onLoadCallback=c;this.onErrorCallback=d;this.request=new XMLHttpRequest;this.request.onreadystatechange=this.onReadyStateChange.bind(this);this.request.onload=this.onReadyStateChange.bind(this);this.request.onloadend=this.onReadyStateChange.bind(this);this.load()},
load:function(a,b){this.onLoadCallback=a;this.onErrorCallback=b;try{this.request.open("get",this.src),this.request.send(null)}catch(c){}finally{}},reload:function(){this.loaded=!1;this.load()},onReadyStateChange:function(){if(!this.loaded&&4===this.request.readyState)if(200===this.request.status){if(this.loaded=!0,this.data=this.request.responseText,this.onLoadCallback)this.onLoadCallback(this)}else if(404===this.request.status&&(this.warn("resource "+this.src+" error "+this.request.status),this.onErrorCallback))this.onErrorCallback(this)}});
h5c3.Math=h5c3.Base("h5c3.Math",{RADIAN_TO_DEGREE:180/Math.PI,DEGREE_TO_RADIAN:Math.PI/180,PI:Math.PI,round:Math.round,random:Math.random,floor:Math.floor,sqr:function(a){return a*a},rand:function(a,b){return h5c3.Math.round(h5c3.Math.random()*(b-a)+a)},randFloat:function(a,b){return h5c3.Math.random()*(b-a)+a},rotate:function(a,b){for(var c=a+b;359<c;)c-=360;for(;0>c;)c=360+c;return c},angleDiff:function(a,b,c){if(c)return b<a&&(b+=360),b-a;a-=b;0>a&&(a+=360);return a},isClockwise:function(a,b){return a>
b?Math.abs(a-b)<b+(360-a):a+(360-b)<Math.abs(b-a)},isFacingRight:function(a){return 270<a||90>a?!0:!1},radToDeg:function(a){return a*h5c3.Math.RADIAN_TO_DEGREE},degToRad:function(a){return a*h5c3.Math.DEGREE_TO_RADIAN},angleFromVector:function(a,b){var c=h5c3.Math.radToDeg(Math.atan2(b,a));0>c&&(c+=360);return c},vectorFromAngle:function(a){var b=Math.cos(h5c3.Math.degToRad(a));a=Math.sin(h5c3.Math.degToRad(a));return h5c3.Point.create(b,a)},isPointInRect:function(a,b,c,d,e,f){return a>=c&&a<=c+e&&
b>=d&&b<=d+f},isRectInRect:function(a,b,c,d,e,f,g,h){return h5c3.Math.isPointInRect(a,b,e,f,g,h)&&h5c3.Math.isPointInRect(a+c,b,e,f,g,h)&&h5c3.Math.isPointInRect(a,b+d,e,f,g,h)?h5c3.Math.isPointInRect(a+c,b+d,e,f,g,h):!1},isRectColliding:function(a,b,c,d,e,f,g,h){return!(b+d<f||b>f+h||a+c<e||a>e+g)},limit:function(a,b,c){return a<b?b:a>c?c:a},limitAdd:function(a,b,c,d){return a+b<c?c:a+b>d?d:a+b}},{});
h5c3.Rect=h5c3.Pooled("h5c3.Rect",{create:function(a,b,c,d){var e=this._super();e.x=a;e.y=b;e.w=c;e.h=d;return e}},{x:0,y:0,w:0,h:0,containsRect:function(a,b,c,d,e,f,g,h){return h5c3.Math.isPointInRect(a,b,e,f,g,h)&&h5c3.Math.isPointInRect(a+c,b,e,f,g,h)&&h5c3.Math.isPointInRect(a,b+d,e,f,g,h)?h5c3.Math.isPointInRect(a+c,b+d,e,f,g,h):!1},containsPoint:function(a){return a.x>=this.x&&a.x<=this.x+this.w&&a.y>=this.y&&a.y<=this.y+this.h},overlaps:function(a,b,c,d,e){var f=c,g=d;$VLD(e)&&0!=e&&(g=Math.sin(h5c3.Math.degToRad(e)),
e=Math.cos(h5c3.Math.degToRad(e)),0>g&&(g=-g),0>e&&(e=-e),f=d*g+c*e,g=d*e+c*g);return!(this.y+this.h<b||this.y>b+g||this.x+this.w<a||this.x>a+f)},toString:function(){return this.x+" x "+this.y+" by "+this.w+" x "+this.h}});
h5c3.Point=h5c3.Pooled("h5c3.Point",{create:function(a,b){var c=this._super();c.x=a;c.y=b;return c}},{x:0,y:0,match:function(a){this.x=a.x;this.y=a.y},set:function(a){this.match(a)},setXY:function(a,b){this.x=a;this.y=b;return this},add:function(a,b){this.x+=a;this.y+=b;return this},subtract:function(a,b){this.x-=a;this.y-=b;return this},dirTo:function(a){var b=Math.abs(a.x-this.x),c=Math.abs(a.y-this.y);0==b&&(b=1);0==c&&(c=1);b=Math.atan(c/b);b=h5c3.Math.radToDeg(b);return a.x<this.x?a.y<this.y?
b+180:90-b+90:a.y<this.y?90-b+270:b},moveInDir:function(a,b){this.x+=b*Math.cos(h5c3.Math.degToRad(a));this.y+=b*Math.sin(h5c3.Math.degToRad(a));return this},moveTowards:function(a,b){this.moveInDir(this.dirTo(a),b)},distance:function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))},toString:function(){return this.x+"x"+this.y}});
h5c3.Poly=h5c3.Pooled("h5c3.Poly",{create:function(a,b,c){var d=this._super();d.x=a;d.y=b;d.points=c;return d}},{x:0,y:0,points:null,_boundingRect:null,init:function(a,b,c){this.x=a;this.y=b;this.points=c;this._boundingRect=h5c3.Rect.create(0,0,0,0)},getBoundingRect:function(){}});h5c3.Dim=h5c3.Point;h5c3.Vector=h5c3.Point;
h5c3.AccuTimer=function(a,b,c,d){function e(){if(h++>=f)d(f,h);else{c(f,h,b);var a=(new Date).getTime()-l-h*g;window.setTimeout(e,g-a)}}0>=a&&(a=864E5);0>=b&&(b=1);var f=a/100*(b/10),g=a/f,h=0,l=(new Date).getTime();window.setTimeout(e,g)};
h5c3.Hashmap=h5c3.Base.extend("h5c3.Hashmap",{},{length:0,items:{},put:function(a,b){if(!$VLD(a))throw"invaid key";this.items[a]=b;this.length++},get:function(a){return this.items[a]},hasKey:function(a){return this.items.hasOwnProperty(a)},remove:function(a){this.hasKey(a)&&(this.length--,delete this.items[a])},keys:function(){var a,b=[];for(a in this.items)b.push(a);return b},values:function(){var a,b=[];for(a in this.items)b.push(this.items[a]);return b},clear:function(){this.items={};this.length=
0}});h5c3.systems={};h5c3.systems.System=h5c3.Base.extend("h5c3.System",{},{layer:null,componentTypes:null,systemManager:null,delay:0,_lastRun:0,init:function(a,b){this._super();this.delay=$CHK(b,0);if(!a instanceof Array)throw"Invalid component types array. Use a blank array ([]) if there are no components handled by the system.";this.componentTypes=a},processAll:function(){},onResize:function(){},onOriginChange:function(a,b){},onAddedToLayer:function(a){},onRemovedFromLayer:function(a){}});
h5c3.systems.EntitySystem=h5c3.systems.System.extend("h5c3.systems.EntitySystem",{},{entities:null,suicides:null,init:function(a,b){this._super(a,b);this.entities=new h5c3.LinkedList;this.suicides=new h5c3.LinkedList},addIfMatched:function(a){for(var b=0;b<this.componentTypes.length;b++)if(a.hasComponentOfType(this.componentTypes[b])){this.entities.add(a);this.onEntityAdded(a);break}},add:function(a){this.entities.has(a)||(this.entities.add(a),this.onEntityAdded(a))},remove:function(a){if(this.entities.remove(a))this.onEntityRemoved(a)},
removeIfNotMatched:function(a){for(var b=0;b<this.componentTypes.length;b++)if(a.hasComponentOfType(this.componentTypes[b]))return;this.remove(a)},processAll:function(){for(var a=this.entities.first;a;)this.process(a.obj),a=a.next();for(a=this.suicides.first;a;)this.remove(a.obj),a=a.next();this.suicides.clear()},process:function(a){},suicide:function(a){this.suicides.add(a)},onEntityAdded:function(a){},onEntityRemoved:function(a){},onComponentAdded:function(a,b){},onComponentRemoved:function(a,b){}});
h5c3.components={};h5c3.components.Component=h5c3.Pooled.extend("h5c3.components.Component",{create:function(){var a=this._super();a.active=!0;return a}},{_entity:null,_type:null,init:function(a){this._super();this._type=a},getType:function(){return this._type.toLowerCase()},getEntity:function(){return this._entity},onBeforeRemoved:function(){}});
h5c3.SystemManager=h5c3.Base.extend("h5c3.SystemManager",{},{systems:null,systemsByComponentType:null,layer:null,init:function(a){this.systems=new h5c3.LinkedList;this.systemsByComponentType=new h5c3.Hashtable;this.layer=a},add:function(a){a.layer=this.layer;a.systemManager=this;this.systems.add(a);if(!$VLD(a.componentTypes))throw"systemmanager.js::add() - Invalid component types: it can be empty, but not undefined. Did you forget to add an init method to your system and/or not call this._super(componentTypes)";
for(var b=0;b<a.componentTypes.length;b++){var c=a.componentTypes[b].toLowerCase(),d=this.systemsByComponentType.get(c);null==d&&(d=new h5c3.LinkedList,this.systemsByComponentType.put(c,d));d.has(a)||d.add(a)}for(b=this.layer.entityManager.entities.first;b;)this._handleEntityAdded(b.object()),b=b.next();a.onAddedToLayer(this.layer)},remove:function(a){a.onRemovedFromLayer(a.layer);this.systems.remove(a);for(var b=0;b<a.componentTypes;b++){var c=this.systemsByComponentType.get(a.componentTypes[b].toLowerCase());
assert(null!=c,"Oops, trying to remove a system and it's not in the by type list");a.systemManager=null;c.remove(a)}},getByComponentType:function(a){return this.systemsByComponentType.get(a)},onOriginChange:function(a,b){for(var c=this.systems.first;c;)c.object().onOriginChange(a,b),c=c.next()},_handleEntityAdded:function(a){for(var b=a.getComponentTypes(),c=0;c<b.length;c++){var d=this.systemsByComponentType.get(b[c].toLowerCase());if(d)for(d=d.first;d;)d.obj.add(a),d=d.next()}},_handleEntityRemoved:function(a){var b=
a.getAllComponents();if(null!=b)for(var b=b.keys(),c=0;c<b.length;c++){var d=this.systemsByComponentType.get(b[c].toLowerCase());if(d)for(d=d.first;d;)d.obj.remove(a),d=d.next()}},_handleComponentAdded:function(a,b){var c=this.systemsByComponentType.get(b.getType());if(null!=c)for(c=c.first;c;)c.obj.add(a),c.obj.onComponentAdded(a,b),c=c.next()},_handleComponentRemoved:function(a,b){var c=this.systemsByComponentType.get(b.getType());if(null!=c)for(c=c.first;c;)c.obj.removeIfNotMatched(a),c.obj.onComponentRemoved(a,
b),c=c.next()},processAll:function(){for(var a=this.systems.first;a;){if(0==a.obj.delay||h5c3.device.now-a.obj._lastRun>a.obj.delay)a.obj.processAll(),0!=a.obj.delay&&(a.obj._lastRun=h5c3.device.now);a=a.next()}},onResize:function(a,b){for(var c=this.systems.first;c;)c.obj.onResize(a,b),c=c.next()}});
h5c3.EntityManager=h5c3.Base.extend("h5c3.EntityManager",{},{entitiesByTag:null,componentsByEntity:null,componentsByEntityPlusType:null,entities:null,entitySuicides:null,layer:null,init:function(a){this.layer=a;this.entitiesByTag=new h5c3.HashList;this.entities=new h5c3.LinkedList;this.componentsByEntity=new h5c3.Hashmap;this.componentsByEntityPlusType=new h5c3.Hashmap;this.entitySuicides=new h5c3.LinkedList},cleanup:function(){for(var a=this.entitySuicides.first;a;)this._doRemoveEntity(a.object()),
a=a.next();this.entitySuicides.clear()},add:function(a,b){this.entities.add(a);void 0!=b&&this.entitiesByTag.add(b,a);var c=a.getAllComponents();if(null!=c)for(var c=c.values(),d=0;d<c.length;d++)this._addToComponentMap(a,c[d]);this.layer.systemManager._handleEntityAdded(a)},remove:function(a){this.entitySuicides.has(a)||(this.entitySuicides.add(a),a.active=!1)},removeComponent:function(a,b){this._removeFromComponentMap(a,b);this.layer.systemManager._handleComponentRemoved(a,b);a._handleComponentRemoved(b);
b._entity=null},addTag:function(a,b){-1==a.tags.indexOf(b.toLowerCase())&&(this.entitiesByTag.add(b.toLowerCase(),a),a.tags.push(b.toLowerCase()))},removeTag:function(a,b){this.entitiesByTag.remove(b.toLowerCase(),a);a.tags.remove(b.toLowerCase())},getTagged:function(a){return this.entitiesByTag.get(a.toLowerCase())},activate:function(a){a.active||(this.layer.systemManager._handleEntityAdded(a),a.active=!0)},deactivate:function(a){a.active&&(this.layer.systemManager._handleEntityRemoved(a),a.active=
!1)},_doRemoveEntity:function(a){this.entities.remove(a);var b=a.getAllComponents();if(null!=b)for(var b=b.values(),c=0;c<b.length;c++)this._removeFromComponentMap(a,b[c]);for(b=0;b<a.tags.length;b++)this.entitiesByTag.remove(a.tags[b],a);this.layer.systemManager._handleEntityRemoved(a);a.release()},addComponent:function(a,b){this._addToComponentMap(a,b);a._handleComponentAdded(b);this.layer.systemManager._handleComponentAdded(a,b);b._entity=a;return b},getComponent:function(a,b){return this.componentsByEntityPlusType.get(a.objectId+
":"+b)},getComponents:function(a){return this.componentsByEntity.get(a.objectId)},hasComponentOfType:function(a,b){return this.componentsByEntityPlusType.containsKey(a.objectId+":"+b)},_addToComponentMap:function(a,b){if(this.componentsByEntityPlusType.get(a.objectId+":"+b.getType()))throw"entitymanager.js::_addToComponentMap() - adding component "+b.getType()+" to entity "+a+" when it already has one of that type";this.componentsByEntityPlusType.put(a.objectId+":"+b.getType(),b);this.componentsByEntity.put(a.objectId,
b)},_removeFromComponentMap:function(a,b){b.onBeforeRemoved();this.componentsByEntityPlusType.remove(a.objectId+":"+b.getType());this.componentsByEntity.remove(a.objectId);b.release()}});
h5c3.Plugin=h5c3.Base.extend("h5c3.Plugin",{},{NAME:"Plugin",VERSION:"0.1.0",DESCRIPTION:"Base class for all plugins.",srcDir:"js/",requires:[],uses:[],init:function(a){this._super();"object"===typeof a&&(this.property=a);$_DBG_("init()");this._load()},_load:function(){$_DBG_("h5c3._load",0,"Loading Plugin "+this.NAME+" v"+this.VERSION);if($VLD(this.uses)&&0<this.uses.length)for(var a=0,a=0;a<$this.uses.length;a++)this.add($scripts[a]);else $_DBG_("h5c3._load",0,"No external files used by plugin.");
$_DBG_("h5c3._load",0,"Completed.")},main:function(a){$_DBG_("main()")},done:function(a){$_DBG_("done()")}});h5c3.SCREEN_CELLS={GRIDX1:0,GRIDX2:1,GRIDX3:2,GRIDX4:4,GRIDX5:8};
h5c3.Device=h5c3.Base.extend("h5c3.Device",{},{device:gamecore.Device,media:gamecore.Media,page:null,loader:null,input:null,inputTimer:null,processTimer:null,xmlParser:null,resourcesLoaded:!1,started:!1,running:!0,fps:30,currentFPS:0,averageFPS:0,totalFPS:0,frameCount:0,tick:0,enablePooling:!0,soundEnabled:!0,elementsDrawn:0,lastProcessMS:0,lastDrawMS:0,elapsed:0,lastFrame:0,now:Date.now(),startTime:0,screen:null,pixelRatio:gamecore.Device.pixelRatio,isiPhone:gamecore.Device.isiPhone,isiPhone4:gamecore.Device.isiPhone4,
isiPad:gamecore.Device.isiPad,isAndroid:gamecore.Device.isAndroid,isTouch:gamecore.Device.isTouch,useTouch:gamecore.Device.useTouch,isiOS:gamecore.Device.isiOS,isiPod:gamecore.Device.isiPod,showDebug:h5c3.devMode,devMode:h5c3.devMode,gameScreenCells:1,init:function(){this._super();$_DBG_("Initialization started.");this.loader=h5c3.loader;this.input=new h5c3.Input},boot:function(){$_DBG_("boot initiated.");this.page=new h5c3.Page(this,"H5C3 Unanamed App");this.game=this.page.game;this.tick=1E3/this.fps;
this.requestAnimFrame=gamecore.Device.requestAnimFrame;this.onReady();$_DBG_("boot complete.")},initLayout:function(){this.layout={cells:h5c3.SCREEN_CELLS.GRIDX1}},canPlay:function(a){return gamecore.Device.canPlay(a)},onReady:function(){$_DBG_("onReady Called.");this.started||(this.page.onReady(),this.input._onReady(),this.lastFrame=Date.now(),window.requestAnimationFrame(this.render.bind(this)),this.handleTimers(!0),this.started=!0)},onExit:function(){this.handleTimers(!1);window.cancelAnimationFrame(!0);
$_DBG_("Animation frame binding canceled.")},handleTimers:function(a){!0===a?($_DBG_("Loader timer started."),this.inputTimer=new h5c3.AccuTimer(0,6,function(a,c,d){h5c3.device.input.process()},function(){h5c3.device.log("Loader Timer terminated.")}),this.processTimer=new h5c3.AccuTimer(0,30,function(a,c,d){h5c3.device.running=!h5c3.device.page.game.obj.process()},function(){h5c3.device.log("Process Timer terminated.")})):($_DBG_("Stop all timers."),this.processTimer=this.inputTimer=null)},render:function(a){if(!1!==
this.running)try{this.now=this.startTime=Date.now(),this.elapsed=this.now-this.lastFrame,this.elementsDrawn=this.lastDrawMS=0,this.currentFPS=1E3/this.elapsed,this.totalFPS+=this.currentFPS,this.frameCount++,this.lastProcessMS=Date.now()-this.startTime-this.lastDrawMS,this.lastFrame=this.now,this.page.render(),window.requestAnimationFrame(this.render.bind(this))}catch(b){$_DBG_("device::render() - "+b)}},isOnScreen:function(a,b,c,d){return h5c3.Math.isRectColliding(a,b,c,d,0,0,this.game.dim.w,this.game.dim.h)}});
h5c3.Banners=h5c3.Base.extend("h5c3.Banners",{},{div:null,init:function(a){this._super();this.div=a},onReady:function(){$_DBG_("onReady Event.")}});
h5c3.Main=h5c3.Base.extend("h5c3.Main",{},{scenes:null,activeScenes:null,paused:!1,ctx:null,dim:null,bQuit:!1,init:function(a){this._super();$_DBG_("Initializing "+this.Class.shortName+" object.");this.ctx=a.ctx;this.dim=a.dim;this.canvas=a.canvas;this.scenes=new h5c3.LinkedList;this.activeScenes=new h5c3.LinkedList;!0===h5c3.devMode&&(h5c3.device.input.bindAction(this,"developer window","F6"),h5c3.device.input.bindAction(this,"physics debug","F7"),h5c3.device.input.bindAction(this,"pool dump","F8"),
h5c3.device.input.bindAction(this,"toggle sound","F9"),h5c3.device.input.bindAction(this,"reset","F10"),h5c3.device.input.bindAction(this,"exit","F12"));$_DBG_("Initialization completed.")},process:function(){if(this.paused||this.bQuit)return this.bQuit;for(var a=this.getFirstActiveScene();a;)a.object().process(),a=a.next();return this.bQuit},stopAllSounds:function(){for(var a=h5c3.loader.getAllSounds(),b=0;b<a.length;b++)h5c3.device.soundEnabled&&a[b].stop()},onAction:function(a){switch(a){case "reset":h5c3.device.boot();
break;case "exit":this.quit();break;case "developer window":$VLD(h5c3.device.page.devWindow)?($_DBG_("Developer Window activated."),h5c3.device.page.devWindow.toggleShow()):$_DBG_("Developer Window not available. Did you include the Plugin in your config? Are you running the debug.html version of your app?");break;case "toggle sound":this.stopAllSounds();h5c3.device.soundEnabled=!h5c3.device.soundEnabled;h5c3.device.soundEnabled?h5c3.device.page.devWindow.send2Console("Sound Enabled."):h5c3.device.page.devWindow.send2Console("Sound Disabled.");
break;case "pool dump":h5c3.device.page.devWindow.send2Console("Object Pool Dump:\n===================");h5c3.device.page.devWindow.send2Console(h5c3.Pool.getStats());break;case "physics debug":for(a=this.getFirstScene();a;){for(var b=a.object().getFirstActiveLayer();b;){var c=b.object();if(c.Class.isA("h5c3.EntityLayer"))for(c=c.systemManager.systems.first;c;){var d=c.object();d.Class.isA("h5c3.systems.Physics")&&d.setDebug(!d.debug);c=c.next()}b=b.next()}a=a.next()}}},addScene:function(a){try{a.ctx=
this.ctx,this.scenes.add(a),this.activeScenes.add(a),this.onSceneAdded(a)}catch(b){$_DBG_("Error Adding scene ["+a+"]: "+b)}},onSceneAdded:function(a){},removeScene:function(a){this.scenes.remove(a);this.activeScenes.remove(a);this.onSceneRemoved(a)},onSceneRemoved:function(a){},activateScene:function(a){"undefined"===typeof a||a.active||(this.activeScenes.add(a),a.active=!0,this.onSceneActivated(a),a.onActivated())},onSceneActivated:function(a){},deactivateScene:function(a){a.active&&(this.activeScenes.remove(a),
a.active=!1,this.onSceneDeactivated(a),a.onDeactivated())},onSceneDeactivated:function(a){},getFirstActiveScene:function(){return this.activeScenes.first},getFirstScene:function(){return this.scenes.first},pause:function(){if(!this.paused){h5c3.device.handleTimers(!1);this.paused=!0;for(var a=this.getFirstScene();a;)a.object().pause(),a=a.next()}},isActive:function(){return!this.paused},resume:function(){if(this.paused){h5c3.device.handleTimers(!0);this.paused=!1;for(var a=this.getFirstScene();a;)a.object().resume(),
a=a.next()}},togglePauseResume:function(){this.paused?this.resume():this.pause()},quit:function(a){$CHK(a,"Quit Signal Received.");$_DBG_(a);this.onExit();this.bQuit=!0},onExit:function(){$_DBG_("WebApp Exiting...")},reset:function(){for(var a=this.getFirstScene();a;)a.obj.reset(),a=a.next();this.scenes.clear();this.activeScenes.clear();this.onReady()},attachTouchEvents:function(a){h5c3.device.useTouch?($_DBG_("Attached Touch Events"),this.canvas.addEventListener("touchstart",a._touchStart.bind(a),
!0),this.canvas.addEventListener("touchend",a._touchEnd.bind(a),!0),this.canvas.addEventListener("touchmove",a._touchMove.bind(a),!0),h5c3.device.touchpad.canvas.addEventListener("touchstart",a._touchStart.bind(a),!0),h5c3.device.touchpad.canvas.addEventListener("touchend",a._touchEnd.bind(a),!0),h5c3.device.touchpad.canvas.addEventListener("touchmove",a._touchMove.bind(a),!0)):($_DBG_("Attached Mouse & Keyboard Events"),this.canvas.addEventListener("selectstart",function(a){a.preventDefault();return!1},
!1),this.canvas.addEventListener("mouseup",a._mouseUp.bind(a),!0),this.canvas.addEventListener("mousedown",a._mouseDown.bind(a),!0),this.canvas.addEventListener("mousemove",a._mouseMove.bind(a),!0),this.canvas.addEventListener("mousewheel",a._mouseWheel.bind(a),!0),this.canvas.addEventListener("contextmenu",a._contextMenu.bind(a),!0))},onReady:function(){$_DBG_("onReady Called.");!0===h5c3.devMode&&h5c3.loader.setDisableCache();if(!1===h5c3.device.resourcesLoaded)try{h5c3.resources.loadResources(),
h5c3.loader.start(this.onLoading.bind(this),this.onLoaded.bind(this)),h5c3.device.resourcesLoaded=!0}catch(a){console.log("ERROR: "+a)}},onResize:function(a,b){for(var c=this.getFirstActiveScene();c;)c.obj.onResize(a,b),c=c.next()},onBlur:function(a){this.paused||(this.pause(),$_DBG_("Lost focus - Paused."))},onFocus:function(a){this.paused&&(this.resume(),$_DBG_("Gained focus - Resuming."))},onLoading:function(a){},onLoaded:function(a,b){},getScreenRect:function(){return h5c3.Rect.create(0,0,h5c3.device.dimGame.w,
h5c3.device.dimGame.h)}});window.SceneID={LOADING:0,PUBLISHER:1,TITLE:2,MAINMENU:3,GAME:4,GAMEOVER:5,CREDITS:6};var GAMESTATE=SceneID.LOADING;
h5c3.Game=h5c3.Main.extend("h5c3.Game",{},{loadingScene:null,publisherScene:null,init:function(a){this._super(a)},onAction:function(a){this._super(a)},setZoom:function(a){},setScene:function(a,b){var c=!1,d="";switch(b){case SceneID.LOADING:$VLD(this.loadingScene)?this.activateScene(this.loadingLayer):(this.loadingScene=new h5c3.Scene("Loading Scene"),this.loadingLayer=new h5c3.Layer({scene:this.loadingScene,name:"LoadingLayer"}),this.loadingScene.addLayer(this.loadingLayer));c=!0;d=this.loadingScene.name;
break;case SceneID.PUBLISHER:$VLD(this.publisherScene)?this.activateScene(this.publisherScene):(this.publisherScene=new h5c3.IntroScene,this.addScene(this.publisherScene));c=!0;d=this.publisherScene.name;break;case SceneID.MAINMENU:$VLD(this.mainmenuScene)?this.activateScene(this.mainmenuScene):(this.mainmenuScene=new MainMenuScene,this.addScene(this.mainmenuScene));c=!0;d=this.mainmenuScene.name;break;case SceneID.GAME:$VLD(this.gameScene)?this.activateScene(this.GameScene):(this.gameScene=new GameScene,
this.addScene(this.gameScene)),c=!0,d=this.gameScene.name}c&&null!==a&&(this.deactivateScene(a),$_DBG_("Deactivated "+a.name+", Activated "+d))},onReady:function(){this._super();$_DBG_("onReady Event.");this.setScene(null,SceneID.LOADING)},onLoading:function(a){var b=this.dim.w/2,c=this.dim.h/2,d=320*(a/100);this.ctx.textAlign="center";this.ctx.clearRect(0,0,this.dim.w,this.dim.h);this.ctx.fillStyle="#00FF00";this.ctx.font="normal 18px Verdana";this.ctx.fillText("Loading: "+a+"%",b,c+9);this.ctx.fillRect(b-
160,c+80,d,16);this.ctx.fillStyle="#00FF00";this.ctx.fill()},onLoaded:function(a,b){h5c3.entityFactory=new h5c3.EntityFactory;h5c3.soundFactory=new h5c3.SoundFactory;this.setScene(this.loadingScene,SceneID.PUBLISHER)}});
h5c3.Page=h5c3.Base.extend("h5c3.Page",{},{device:null,wrapper:{div:null,dim:{w:0,h:0}},banner:{name:null,obj:null,id:null,div:null,dim:{w:0,h:0}},game:{name:null,obj:null,id:null,canvas:null,ctx:null,dim:{w:0,h:0}},touchpad:{name:null,obj:null,id:null,canvas:null,ctx:null,dim:{w:0,h:0}},options:{desktopsuspend:!0,suspend:!0,network:!0},orientation:{event:!1,state:null},devWindow:null,init:function(a,b){this._super();this.device=a;$CHK(b,"Undefined Page");$DOC().title=b;this.wrapper.div=$GEI("waDIV");
$_DBG_("Initialization started.");$_DBG_("UA="+window.navigator.userAgent);$_DBG_("Detected Device Screen Dimensions are ["+window.screen.availWidth+"x"+window.screen.availHeight+"]");$_DBG_("Detected Device Usable Dimensions are ["+window.innerWidth+"x"+window.innerHeight+"]");this.device.useTouch?($_DBG_("Mobile Media Detected "+this.device.media.browser.name+" v"+this.device.media.browser.version+" on "+this.device.media.OS.name),this.initBanner(),this.initGame(),this.initTouchPad()):($_DBG_("Static Media Detected "+
this.device.media.browser.name+" v"+this.device.media.browser.version+" on "+this.device.media.OS.name),this.initGame());!0===this.options.suspend?($_DBG_("OPTION: Suspened on focus enabled."),window.addEventListener("blur",this._onBlur.bind(this),!0),window.addEventListener("focus",this._onFocus.bind(this),!0)):$_DBG_("OPTION: Suspened on focus disabled.");!0===this.options.network?($_DBG_("OPTION: Network monitoring enabled."),window.document.addEventListener("offline",this._onOffline.bind(this),
!0),window.document.addEventListener("online",this._onOnline.bind(this),!0)):$_DBG_("OPTION: Network monitoring disabled.");window.onresize=this._onResize.bind(this)},initBanner:function(){var a=$GEI("waDIV");this.banner.div=document.createElement("div");this.banner.div.id=this.banner.id="waBannerDIV";this.banner.div.width=window.innerWidth;this.banner.div.height=32;a.appendChild(this.banner.div);this.banner.div||$_DBG_("Could not get a banner element using the id ["+this.banner.id+"]. ");this.banner.obj=
new h5c3.Banners(this.banner.div);this.banner.obj||$_DBG_("Invalid Banner class. Must be named [Banners]");this.banner.dim={w:this.banner.div.width,h:this.banner.div.height};$_DBG_("Created Banner panel ["+this.banner.dim.w+"x"+this.banner.dim.h+"]")},initGame:function(){this.setOrientation();$VLD(this.game.canvas=$GEI("waCANVAS"))?(this.game.ctx=this.game.canvas.getContext("2d"),this.game.dim={w:this.game.canvas.width,h:this.game.canvas.height},"function"===typeof Game&&(this.game.obj=new Game(this.game),
$VLD(this.game.obj)?$_DBG_("Created Game panel ["+this.game.dim.w+"x"+this.game.dim.h+"]"):$_DBG_("ERROR: Invalid Game class, Must be named [Game]"))):$_DBG_("ERROR: Could not attach to a canvas element using the id ["+this.game.id+"]. ")},initTouchPad:function(){var a=$GEI("waDIV");this.touchpad.canvas=document.createElement("canvas");this.touchpad.canvas.id=this.touchpad.id="pcTouchCanvas";this.touchpad.canvas.width=1080;this.touchpad.canvas.height=540;a.appendChild(this.touchpad.canvas);if(!this.touchpad.canvas)throw"device.js::initTouchpad() - Abort! Could not attach to a canvas element using the id ["+
this.touchpad.id+"]. ";this.touchpad.ctx=this.touchpad.canvas.getContext("2d");this.touchpad.dim={w:this.touchpad.canvas.width,h:this.touchpad.canvas.height};this.touchpad.obj=new h5c3.TouchPad(this.touchpad.ctx,this.touchpad.dim);if(!this.touchpad.obj)throw"device.js::initTouchpad() - Invalid touchpad class. Must be named [TouchPad]";$_DBG_("Created Touchpad panel ["+this.touchpad.dim.w+"x"+this.touchpad.dim.h+"]")},setOrientation:function(){this.device.started&&(window.DeviceOrientationEvent?(this.orientation.event=
!0,$_DBG_("Device Orientation is supported - Event Hooked Added."),window.addEventListener("deviceorientation",this.onDeviceMotion,!1)):(this.orientation.event=!1,$_DBG_("Device Orientation not supported")),this.orientation.state=h5c3.device.useTouch||window.innerHeight>window.innerWidth?H5c3.ORIENTATION.PORTRAIT:H5C3.ORIENTATION.LANDSCAPE)},onDeviceMotion:function(a){null!==a.alpha&&null!==a.beta&&null!==a.gamma||!0!==h5c3.device.page.orientation.event||(window.removeEventListener("deviceorientation",
this.onDeviceMotion,!1),h5c3.device.page.orientation.event=!1,h5c3.device.page.debug("This device does not REALLY have orientation capabilities - Event Hooked Removed."))},_calcScreenSize:function(){this.orientation.state===H5C3.ORIENTATION.LANDSCAPE?($_DBG_("Orientation set to Landscape."),document.fullScreen||$GEI("waCANVAS").webkitRequestFullScreen()):$_DBG_("Orientation set to Portrait.");this.wrapper.dim.w=window.innerWidth;this.wrapper.div.width=this.wrapper.dim.w+"px";this.wrapper.div.style.width=
this.wrapper.dim.w+"px";this.wrapper.dim.h=window.innerHeight;this.wrapper.div.height=this.wrapper.dim.h+"px";this.wrapper.div.style.height=this.wrapper.dim.h+"px";$_DBG_("Calculated screen space is ["+this.wrapper.dim.w+"x"+this.wrapper.dim.h+"]");var a=this.wrapper.dim.h;h5c3.device.useTouch?(this.game.dim.w=this.wrapper.dim.w,this.game.canvas.style.width=this.game.dim.w+"px",this.game.dim.h=this.wrapper.dim.w,this.game.canvas.style.height=this.game.dim.h+"px",a-=this.game.dim.h,this.touchpad.dim.w=
this.wrapper.dim.w,this.touchpad.canvas.style.width=this.touchpad.dim.w+"px",this.touchpad.dim.h=a,this.touchpad.canvas.style.height=this.touchpad.dim.h+"px",a-=this.touchpad.dim.h):(this.game.dim.w=this.wrapper.dim.w,this.game.canvas.style.width=this.game.dim.w+"px",this.game.dim.h=this.wrapper.dim.h,this.game.canvas.style.height=a+"px",a-=a);$_DBG_("Used ["+this.game.dim.w+"x"+this.game.dim.h+"] for Game Panel.");$_DBG_("Used ["+this.touchpad.dim.w+"x"+this.touchpad.dim.h+"] for Touchpad Panel.");
0!==a&&$_DBG_("Layout was not done correctly. "+a+"px difference.")},render:function(){},waDIV:function(a){$CHK(a,!0);this.wrapper.div.display="none";!0===a?this.wrapper.div.innerHTML="":document.location.reload();this.wrapper.div.display="block"},_onBlur:function(a){this.game.obj.onBlur()},_onFocus:function(a){this.game.obj.onFocus()},_onOffline:function(a){$_DBG_("Lost network connection.")},_onOnline:function(a){$_DBG_("Gained network connection.")},_onResize:function(a){$_DBG_("Dimension changed detected.");
this._calcScreenSize();this.game.dim.w=this.game.canvas.width;this.game.dim.h=this.game.canvas.height;this.game.obj.onResize(this.game.dim.w,this.game.dim.h)},onReady:function(){$_DBG_("onReady Called.");this.game.obj.onReady();if(h5c3.device.useTouch)this.touchpad.obj.onReady()}});
h5c3.Color=h5c3.Pooled.extend("h5c3.Color",{create:function(a){var b=this._super();b.config(a);return b}},{rgb:[],color:null,init:function(a){void 0!==a&&this.config(a)},config:function(a){if(Array.isArray(a))this.rgb=a;else if("#"===a.charAt(0))this.rgb[0]=parseInt(a.substring(1,3),16),this.rgb[1]=parseInt(a.substring(3,5),16),this.rgb[2]=parseInt(a.substring(5,7),16);else throw"color.js::config() - Invalid color: use either array [r,g,b] or '#RRGGBB'";this._updateColorCache()},set:function(a){this.config(a)},
setRed:function(a){this.rgb[0]=h5c3.Math.limit(a,0,255);this._updateColorCache()},addRed:function(a){this.rgb[0]=h5c3.Math.limitAdd(this.rgb[0],a,0,255);this._updateColorCache()},subRed:function(a){this.rgb[0]=h5c3.Math.limitAdd(this.rgb[0],-a,0,255);this._updateColorCache()},setGreen:function(a){this.rgb[1]=h5c3.Math.limit(a,0,255);this._updateColorCache()},addGreen:function(a){this.rgb[1]=h5c3.Math.limitAdd(this.rgb[1],a,0,255);this._updateColorCache()},subGreen:function(a){this.rgb[1]=h5c3.Math.limitAdd(this.rgb[1],
-a,0,255);this._updateColorCache()},setBlue:function(a){this.rgb[2]=h5c3.Math.limit(a,0,255);this._updateColorCache()},addBlue:function(a){this.rgb[2]=h5c3.Math.limitAdd(this.rgb[2],a,0,255);this._updateColorCache()},subBlue:function(a){this.rgb[2]=h5c3.Math.limitAdd(this.rgb[2],-a,0,255);this._updateColorCache()},darken:function(a){this.subRed(a);this.subGreen(a);this.subBlue(a)},lighten:function(a){this.addRed(a);this.addGreen(a);this.addBlue(a)},_updateColorCache:function(){this.color="rgb("+this.rgb[0]+
","+this.rgb[1]+","+this.rgb[2]+")"}});
h5c3.Factory=h5c3.Base.extend("h5c3.Factory",{},{objects:{},init:function(a){this._super();$CHK(a,"Undefined Factory");this.factoryType=a;$_DBG_(a+" Factory Initialized.")},create:function(){},add:function(a,b){if($VLD(b))return this.objects[a]=b,this.objects.length++,this.objects[a];$_DBG_("You cannot add ["+a+"] which is null or undefined to the ["+this.factoryType+"] store")},remove:function(a){try{var b=this.objects.indexOf(a);this.objects.pop(b);this.objects.length--}catch(c){$_DBG_("No object ["+a+
" exists in ["+this.factoryType+"] store to remove.")}},exists:function(a){return this.objects.hasOwnProperty(a)?!0:!1},use:function(a,b){return this.exists(a)?this.objects[a]:this.create(a,b)}});window.STATES={SELECTABLE:1,DRAGGABLE:2,HOVERABLE:3};
h5c3.Entity=h5c3.Pooled.extend("h5c3.Entity",{create:function(a){var b=this._super();$AST(a,"Entity requires a valid layer to be placed on");b.config(a);return b}},{layer:null,tags:[],active:!0,_componentCache:null,init:function(a){this._super();this._componentCache=new h5c3.Hashmap;$VLD(a)&&this.config(a)},config:function(a){this.layer=a;this.active=!0;a.entityManager.add(this)},release:function(){this.tags.length=0;this.active=!1;this._componentCache.clear();this._super()},addTag:function(a){this.layer.entityManager.addTag(this,
a)},hasTag:function(a){for(var b=0,b=0;b<this.tags.length;b++)if(this.tags[b].toLowerCase()===a.toLowerCase())return!0;return!1},removeTag:function(a){this.layer.entityManager.removeTag(this,a)},addComponent:function(a){return this.layer.entityManager.addComponent(this,a)},removeComponent:function(a){this.layer.entityManager.removeComponent(this,a)},removeComponentByType:function(a){this.removeComponent(this._componentCache.get(a.toLowerCase()))},getComponent:function(a){return this._componentCache.get(a.toLowerCase())},
getAllComponents:function(){return this._componentCache},getComponentTypes:function(){return this._componentCache.keys()},hasComponentOfType:function(a){return this._componentCache.hasKey(a.toLowerCase())},remove:function(){this.layer.entityManager.remove(this);this.onRemoved()},onRemoved:function(){$_DBG_("Entity "+this.uniqueId+" has been removed.")},_handleComponentRemoved:function(a){this._componentCache.remove(a.getType())},_handleComponentAdded:function(a){this._componentCache.put(a.getType(),
a)}});h5c3.EntityFactory=h5c3.Factory.extend("h5c3.EntityFactory",{},{init:function(){this._super("Entity")},create:function(a,b){$CHK(a,!1);$CHK(b.layer,!1);if(!a||!b.layer)throw"entity.js::create() - You must provide a name & layer for first use.";var c=h5c3.Entity.create(b.layer);c.addTag(a);return this.add(a,c)}});
h5c3.Layer=h5c3.Base.extend("h5c3.Layer",{},{name:null,paused:!1,active:!1,scene:null,zIndex:0,originTrack:null,originTrackXRatio:1,originTrackYRatio:1,origin:null,init:function(a){this._super();this.scene=a.scene;this.name=a.name;this.origin=h5c3.Point.create(0,0);this._worldPos=h5c3.Point.create(0,0);this._screenPos=h5c3.Point.create(0,0);this.zIndex=$CHK(a.zIndex,0);this.originTrack=null;this.originTrackYRatio=this.originTrackXRatio=0},toString:function(){return""+this.name+" (origin: "+this.origin+
", zIndex: "+this.zIndex+")"},release:function(){this.origin.release()},isActive:function(){return null==this.scene||this.scene.active?this.active:!1},setActive:function(){this.scene.setLayerActive(this)},setInactive:function(){this.scene.setLayerInactive(this)},setZIndex:function(a){this.zIndex=a;this.scene&&this.scene.sortLayers()},_worldPos:null,worldPos:function(a){this._worldPos.x=a.x+this.origin.x;this._worldPos.y=a.y+this.origin.y;return this._worldPos},screenX:function(a){return a+this.scene.viewPort.x-
this.origin.x},screenY:function(a){return a+this.scene.viewPort.y-this.origin.y},getScreenRect:function(){try{return this.scene.getScreenRect()}catch(a){return this.error("Scene property is NULL."),null}},draw:function(){},setOriginTrack:function(a,b,c){this.originTrack=a;this.originTrackXRatio=$CHK(b,1);this.originTrackYRatio=$CHK(c,1)},setOrigin:function(a,b){if(this.origin.x==Math.round(a)&&this.origin.y==Math.round(b))return!1;this.origin.x=Math.round(a);this.origin.y=Math.round(b);return!0},
process:function(){this.originTrack&&this.setOrigin(this.originTrack.origin.x*this.originTrackXRatio,this.originTrack.origin.y*this.originTrackYRatio)},pause:function(){this.paused=!0},resume:function(){this.paused=!1},onResize:function(a,b){},onAddedToScene:function(){},onRemovedFromScene:function(){},onAction:function(a,b,c,d){}});
h5c3.EntityLayer=h5c3.Layer.extend("h5c3.EntityLayer",{loadFromTMX:function(a,b,c){var d=b.getAttribute("name");n=new h5c3.EntityLayer(d);objs=b.getElementsByTagName("object");a.addLayer(n);for(a=0;a<objs.length;a++){var e=objs[a];b=null;var d=parseInt(e.getAttribute("x")),f=parseInt(e.getAttribute("y")),g=parseInt(e.getAttribute("width")),h=parseInt(e.getAttribute("height")),l=null,k=e.getElementsByTagName("polygon");if(0<k.length){l=[];g=k[0].getAttribute("points").split(" ");for(h=0;h<g.length;h++)k=
g[h].split(","),l.push([parseInt(k[0]),parseInt(k[1])]);l=h5c3.Poly.create(d,f,l)}else l=h5c3.Dim.create(g,h);g={};e=e.getElementsByTagName("properties");if(e.length)for(e=e[0].getElementsByTagName("property"),h=0;h<e.length;h++){var k=e[h].getAttribute("name"),p=e[h].getAttribute("value");g[k]=p;"entity"===k&&(b=p)}b?c.createEntity(n,b,d,f,0,l,g):this.warn('Entity loaded from map with no "entity" type property set. x='+d+" y="+f)}}},{worldSize:null,entityManager:null,systemManager:null,init:function(a){this._super(a);
this.entityFactory=h5c3.entityFactory;this.systemManager=new h5c3.SystemManager(this);this.entityManager=new h5c3.EntityManager(this);this.worldSize=h5c3.Dim.create($CHK(a.worldSizeX,1E4),$CHK(a.worldSizeY,1E4))},setOrigin:function(a,b){var c=this._super(a,b);if(c)this.systemManager.onOriginChange(a,b);return c},getEntityManager:function(){return this.entityManager},getSystemManager:function(){return this.systemManager},addSystem:function(a){this.systemManager.add(a,this.entityManager)},getSystemsByComponentType:function(a){return this.systemManager.getByComponentType(a)},
removeSystem:function(a){this.systemManager.remove(a)},process:function(){this._super();this.systemManager.processAll();this.entityManager.cleanup()},onResize:function(a,b){this.systemManager.onResize(a,b)}});
h5c3.Sound=h5c3.Base.extend("h5c3.Sound",{},{sounds:[],src:null,name:null,numLoaded:0,loaded:!1,errored:!1,channels:1,onLoadCallback:null,onErrorCallback:null,init:function(a,b,c,d,e,f){this._super();this.name=a;this.channels=d;a=!1;for(d=0;d<c.length;d++)if(h5c3.device.canPlay(c[d])){this.src=h5c3.loader.makeUrl(b+"."+c[d]);a=!0;break}a?h5c3.loader.started&&this.load(e,f):this.errored=!0},pause:function(){if(this.canPlay())for(var a=0,b=this.sounds.length;a<b;a++)this.sounds[a].pause()},stop:function(){this.canPlay()&&
this.pause()},setVolume:function(a){if(this.canPlay())for(var b=0,c=this.sounds.length;b<c;b++)this.sounds[b].volume=a},setLoop:function(a){if(this.canPlay())for(var b=0,c=this.sounds.length;b<c;b++)this.sounds[b].loop=a},getDuration:function(){return this.canPlay()?this.sounds[0].duration:-1},setPlaybackRate:function(a){if(this.canPlay())for(var b=0,c=this.sounds.length;b<c;b++)this.sounds[b].playbackRate=a},setPlayPosition:function(a){if(this.canPlay())for(var b=0,c=this.sounds.length;b<c;b++)this.sounds[b].currentTime=
a},load:function(a,b){this.onLoadCallback=a;this.onErrorCallback=b;if(this.loaded&&a)this.onLoadCallback(this);else for(var c=0;c<this.channels;c++){var d=new Audio;d.preload="auto";d.addEventListener("canplaythrough",this.onLoad.bind(this),!1);d.addEventListener("error",this.onError.bind(this),!1);d.onerror=this.onError.bind(this);d.onload=this.onLoad.bind(this);d.src=this.src;d.load();this.sounds.push(d);if(h5c3.device.isAppMobi)this.onLoad(null)}},reload:function(){this.errored=this.loaded=!1;
this.load()},onLoad:function(a){this.numLoaded++;h5c3.device.isAppMobi||a.target.removeEventListener("canplaythrough",this.onLoad.bind(this),!1);if(this.numLoaded==this.channels&&(this.loaded=!0,this.errored=!1,this.onLoadCallback))this.onLoadCallback(this)},onError:function(){this.errored=!0;this.loaded=!1;if(this.onErrorCallback)this.onErrorCallback(this)},play:function(a){if(!this.canPlay())return null;for(var b=0,c=this.sounds.length;b<c;b++)if(this.sounds[b].paused||this.sounds[b].ended)return a&&
(this.sounds[b].loop=!0),this.sounds[b].play(),this.sounds[b];this.warn(this.name+" - all channels are in use");return null},canPlay:function(){return this.loaded&&h5c3.device.soundEnabled&&!this.errored}});h5c3.SoundFactory=h5c3.Factory.extend("h5c3.SoundFactory",{},{init:function(){this._super("Sound")},create:function(a,b){$CHK(b,{volume:0.5,loop:!1});var c=h5c3.loader.get(a).resource;c.setVolume(b.volume);c.setLoop(b.loop);return this.add(a,c)},play:function(a,b){this.use(a,b).play(b.loop)}});
h5c3.Sprite=h5c3.Pooled.extend("h5c3.Sprite",{create:function(a){var b=this._super();b.config(a);return b}},{currentFrame:0,currentAnim:null,spriteSheet:null,animSpeedOffset:0,currentAnimName:null,alpha:1,scaleX:1,scaleY:1,active:!0,hold:!1,loopCount:0,compositeOperation:null,_acDelta:0,init:function(a){this._super();this.config(a)},config:function(a){(this.spriteSheet=$CHK(a,null))&&this.reset()},reset:function(){this.currentFrame=0;this.alpha=1;this.loopCount=0;this.scaleY=this.scaleX=1;this.active=
!0;this.hold=!1;0<this.spriteSheet.animations.size()?(this.currentAnim=this.spriteSheet.animations.get(this.spriteSheet.animations.keys()[0]),this.currentFrame=0):this.currentAnim=null},setSpriteSheet:function(a){this.spriteSheet=a;this.reset()},setScale:function(a,b){this.scaleX=a;this.scaleY=b},setCompositeOperation:function(a){this.compositeOperation=a},draw:function(a,b,c,d){1!=this.alpha&&(this.spriteSheet.alpha=this.alpha);null!=this.compositeOperation&&this.spriteSheet.setCompositeOperation(this.compositeOperation);
1==this.scaleX&&1==this.scaleY||this.spriteSheet.setScale(this.scaleX,this.scaleY);this.spriteSheet.draw(a,this,b,c,d);1==this.scaleX&&1==this.scaleY||this.spriteSheet.setScale(1,1);1!=this.alpha&&(this.spriteSheet.alpha=1);null!=this.compositeOperation&&this.spriteSheet.setCompositeOperation("source-over")},drawFrame:function(a,b,c,d,e,f){1!=this.alpha&&(this.spriteSheet.alpha=this.alpha);1==this.scaleX&&1==this.scaleY||this.spriteSheet.setScale(this.scaleX,this.scaleY);null!=this.compositeOperation&&
this.spriteSheet.setCompositeOperation(this.compositeOperation);this.spriteSheet.drawFrame(a,b,c,d,e,f);1==this.scaleX&&1==this.scaleY||this.spriteSheet.setScale(1,1);1!=this.alpha&&(this.spriteSheet.alpha=1);null!=this.compositeOperation&&this.spriteSheet.setCompositeOperation("source-over")},update:function(a){null!=this.currentAnim&&(this.active&&!this.hold)&&this.spriteSheet.update(this,a)},setAnimation:function(a,b,c){if($CHK(c,!0)||this.currentAnim.name!==a)this.currentAnim=this.spriteSheet.animations.get(a),
this.loopCount=this.currentFrame=0,this.active=!0,this.held=!1,this.animSpeedOffset=$CHK(b,0),this.currentAnimName=a},setAnimationSpeedOffset:function(a){this.animSpeedOffset=a},setCurrentFrame:function(a){this.currentFrame=a},getAnimation:function(){return this.currentAnimName},setAlpha:function(a){this.alpha=a},addAlpha:function(a){this.alpha+=a;1<this.alpha&&(this.alpha=1)},subAlpha:function(a){this.alpha-=a;0>this.alpha&&(this.alpha=0)}});
h5c3.SpriteSheet=h5c3.Base.extend("h5c3.SpriteSheet",{},{image:null,frameWidth:0,frameHeight:0,framesWide:1,framesHigh:1,scaleX:1,scaleY:1,sourceX:0,sourceY:0,alpha:1,useRotation:!1,compositeOperation:null,totalFrames:0,animations:null,_frameXPos:null,_frameYPos:null,init:function(a){this._super();if($CHK(a.image))this.image=a.image;else throw"No image supplied";$VLD(a.frameWidth)?this.frameWidth=a.frameWidth:$VLD(a.framesWide)&&0<a.framesWide?this.frameWidth=this.image.width/a.framesWide:this.frameWidth=
this.image.width;$VLD(a.frameHeight)?this.frameHeight=a.frameHeight:$VLD(a.framesHigh)&&0<a.framesHigh?this.frameHeight=this.image.height/a.framesHigh:this.frameHeight=this.image.height;this.framesWide=$CHK(a.framesWide,this.image.width/this.frameWidth);this.framesHigh=$CHK(a.framesHigh,this.image.height/this.frameHeight);this.scaleX=$CHK(a.scaleX,1);this.scaleY=$CHK(a.scaleY,1);this.sourceX=$CHK(a.sourceX,0);this.sourceY=$CHK(a.sourceY,0);this.alpha=$CHK(a.alpha,1);this.useRotation=$CHK(a.useRotation,
!0);this.totalFrames=this.framesWide*this.framesHigh;this.animations=new h5c3.Hashtable;this._frameXPos=[];for(a=0;a<this.framesWide;a++)this._frameXPos.push(a*this.frameWidth);this._frameYPos=[];for(a=0;a<this.framesHigh;a++)this._frameYPos.push(a*this.frameHeight)},addAnimation:function(a){if(!$VLD(a.name))throw"Animation requires a name for reference";a.frameX=$CHK(a.frameX,0);a.frameY=$CHK(a.frameY,0);a.directions=$CHK(a.directions,1);a.time=$CHK(a.time,1E3);a.loops=$CHK(a.loops,0);a.holdOnEnd=
$CHK(a.holdOnEnd,!1);a.dirAcross=$CHK(a.dirAcross,!1);a.scaleX=$CHK(a.scaleX,1);a.scaleY=$CHK(a.scaleY,1);a.offsetX=$CHK(a.offsetX,0);a.offsetY=$CHK(a.offsetY,0);a.framesWide=$CHK(a.framesWide,this.framesWide);a.framesHigh=$CHK(a.framesHigh,this.framesHigh);a.frameCount=$CHK(a.frameCount,this.framesWide*this.framesHigh);0==a.frameCount&&(a.frameCount=$CHK(a.frameCount,this.framesWide*this.framesHigh));if(!$VLD(a.frames)){var b=a.frameX+a.frameY*a.framesWide;a.frames=[];for(var c=b;c<b+a.frameCount;c++)a.frames.push([c%
a.framesWide,Math.floor(c/a.framesWide)])}a.frameRate=a.time/a.frames.length;a.degreesPerDir=360/a.directions;this.animations.put(a.name,a)},setAnimation:function(a,b,c){a.currentAnim=this.animations.get(b);null==a.currentAnim&&this.warn("attempt to set unknown animation ["+b+"]");a.currentFrame=0;a.held=!1;a.animSpeedOffset=$CHK(c,0)},hasAnimation:function(a){return null!=this.animations.get(a)},setScale:function(a,b){this.scaleX=a;this.scaleY=b},setCompositeOperation:function(a){this.compositeOperation=
a},dirTmp:0,draw:function(a,b,c,d,e){if(this.image.loaded&&null!=b&&b.active){1==this.scaleX&&1==this.scaleY||this.image.setScale(this.scaleX,this.scaleY);1!=b.alpha&&(this.image.alpha=b.alpha);null!=this.compositeOperation&&this.image.setCompositeOperation(this.compositeOperation);if(null==b.currentAnim)1==this.scaleX&&1==this.scaleY||this.image.setScale(this.scaleX,this.scaleY),this.image.draw(a,this.sourceX,this.sourceY,Math.round(c),Math.round(d),this.frameWidth,this.frameHeight,this.useRotation?
e:0);else{var f=0,g=0;1==b.currentAnim.scaleX&&1==b.currentAnim.scaleY&&1==this.scaleX&&1==this.scaleY||this.image.setScale(b.currentAnim.scaleX*this.scaleX,b.currentAnim.scaleY*this.scaleY);this.useRotation?(f=b.currentAnim.frames[b.currentFrame][0],g=b.currentAnim.frames[b.currentFrame][1],this.image.draw(a,this.sourceX+this._frameXPos[f],this.sourceY+this._frameYPos[g],b.currentAnim.offsetX+h5c3.Math.round(c),b.currentAnim.offsetY+h5c3.Math.round(d),this.frameWidth,this.frameHeight,e)):(this.dirTmp=
Math.round(e/b.currentAnim.degreesPerDir),this.dirTmp>b.currentAnim.directions-1&&(this.dirTmp=0),f=b.currentAnim.frames[b.currentFrame][1]+this.dirTmp,g=b.currentAnim.frames[b.currentFrame][0],1==b.currentAnim.directions&&(g=b.currentAnim.frames[b.currentFrame][1],f=b.currentAnim.frames[b.currentFrame][0]),this.image.draw(a,this.sourceX+this._frameXPos[f],this.sourceY+this._frameYPos[g],b.currentAnim.offsetX+h5c3.Math.round(c),b.currentAnim.offsetY+h5c3.Math.round(d),this.frameWidth,this.frameHeight),
1==b.currentAnim.scaleX&&1==b.currentAnim.scaleY&&1==this.scaleX&&1==this.scaleY||this.image.setScale(b.currentAnim.scaleX*this.scaleX,b.currentAnim.scaleY*this.scaleY))}1==this.image.scaleX&&1==this.image.scaleY||this.image.setScale(1,1);1!=b.alpha&&(this.image.alpha=1);null!=this.compositeOperation&&this.image.setCompositeOperation("source-over")}},drawFrame:function(a,b,c,d,e,f){this.image.loaded&&(1>this.alpha&&(a.globalAlpha=this.alpha),1==this.scaleX&&1==this.scaleY||this.image.setScale(this.scaleX,
this.scaleY),null!=this.compositeOperation&&this.image.setCompositeOperation(this.compositeOperation),this.image.draw(a,this.sourceX+this._frameXPos[b],this.sourceY+this._frameYPos[c],h5c3.Math.round(d),h5c3.Math.round(e),this.frameWidth,this.frameHeight,f),1==this.image.scaleX&&1==this.image.scaleY||this.image.setScale(1,1),1>this.alpha&&(a.globalAlpha=1),null!=this.compositeOperation&&this.image.setCompositeOperation("source-over"))},drawAllFrames:function(a,b,c){for(var d=0;d<this.framesHigh;d++)for(var e=
0;e<this.framesWide;e++)this.drawFrame(a,e,d,b+e*this.frameWidth,c+d*this.frameHeight)},update:function(a,b){null==a.currentAnim||(!a.active||a.held)||1>=a.currentAnim.frames.length||(a._acDelta>a.currentAnim.frameRate+a.animSpeedOffset?(a.currentFrame++,a.currentFrame>=a.currentAnim.frames.length&&(a.loopCount++,a.currentAnim.loops&&a.loopCount>=a.currentAnim.loops&&(a.currentAnim.holdOnEnd?(a.held=!0,a.currentFrame&&a.currentFrame--):a.active=!1),a.held||(a.currentFrame=0)),a._acDelta-=a.currentAnim.frameRate):
a._acDelta+=b)},reset:function(){this.animations=this.image=null}});
h5c3.Image=h5c3.Base.extend("h5c3.Image",{},{width:0,height:0,image:null,src:null,name:null,loaded:!1,onLoadCallback:null,onErrorCallback:null,scaleX:1,scaleY:1,alpha:1,compositeOperation:null,init:function(a,b,c,d){this._super();this.name=a;this.src=h5c3.loader.makeUrl(b);this.image=new Image;this.onLoadCallback=c;this.onErrorCallback=d;this.image.onload=this._onLoad.bind(this);this.image.onerror=this._onError.bind(this);this.alpha=this.scaleY=this.scaleX=1;h5c3.loader.started&&this.load()},setAlpha:function(a){this.alpha=
a},setScale:function(a,b){this.scaleX=a;this.scaleY=b},setCompositeOperation:function(a){this.compositeOperation=a},load:function(a,b){this.onLoadCallback=a;this.onErrorCallback=b;if(this.loaded&&a)this.onLoadCallback(this);this.image.onload=this._onLoad.bind(this);this.image.onerror=this._onError.bind(this);this.image.src=this.src},reload:function(){this.loaded=!1;this.load()},draw:function(a,b,c,d,e,f,g,h){null!=this.compositeOperation&&(a.globalCompositeOperation=this.compositeOperation);3==arguments.length?
(a.save(),1!=this.alpha&&(a.globalAlpha=this.alpha),a.translate(b+this.width/2,c+this.height/2),a.scale(this.scaleX,this.scaleY),a.drawImage(this.image,0,0,this.width,this.height,-this.width/2,-this.height/2,this.width,this.height)):$VLD(h)?(a.save(),1!=this.alpha&&(a.globalAlpha=this.alpha),0>this.scaleX||0>this.scaleY?a.translate(d+f/2*(1==this.scaleX?0:this.scaleX),e+g/2*(1==this.scaleY?0:this.scaleY)):a.translate(d+f/2,e+g/2),a.rotate(h*(Math.PI/180)),a.scale(this.scaleX,this.scaleY),a.drawImage(this.image,
b,c,f,g,-f/2,-g/2,f,g)):(a.save(),1!=this.alpha&&(a.globalAlpha=this.alpha),0>this.scaleX||0>this.scaleY?a.translate(d+-(f/2)*(1==this.scaleX?0:this.scaleX),e+-(g/2)*(1==this.scaleY?0:this.scaleY)):a.translate(d,e),a.scale(this.scaleX,this.scaleY),a.drawImage(this.image,b,c,f,g,0,0,f,g));a.restore();null!=this.compositeOperation&&(a.globalCompositeOperation="source-over");h5c3.device.elementsDrawn++},_onLoad:function(){this.loaded=!0;this.width=this.image.width;this.height=this.image.height;if(this.onLoadCallback)this.onLoadCallback(this)},
_onError:function(){if(this.onErrorCallback)this.onErrorCallback(this)},expand:function(a,b){this.image.width=this.width+a;this.image.height=this.height+b;this.width=this.image.width;this.height=this.image.height},resize:function(a,b){var c=this.width*a,d=this.height*b,e=document.createElement("canvas");e.width=this.width;e.height=this.height;var f=document.createElement("canvas");f.width=c;f.height=d;var g=f.getContext("2d"),h=g.getImageData(0,0,c,d),e=e.getContext("2d");e.drawImage(this.image,0,
0,this.width,this.height,0,0,this.width,this.height);for(var e=e.getImageData(0,0,this.width,this.height),l=0;l<d;l++)for(var k=0;k<c;k++)for(var p=4*(Math.floor(l/b)*this.width+Math.floor(k/a)),q=4*(l*c+k),m=0;4>m;m++)h.data[q+m]=e.data[p+m];g.putImageData(h,0,0);this.image=f;return this}});
h5c3.CanvasImage=h5c3.Base.extend("h5c3.CanvasImage",{},{width:0,height:0,canvas:null,loaded:!0,scaleX:1,scaleY:1,init:function(a){this.canvas=a;this.width=a.width;this.height=a.height},draw:function(a,b,c,d,e,f,g){void 0==f||void 0==g||0==f||0==g?a.drawImage(this.canvas,b,c):a.drawImage(this.canvas,b,c,f,g,d*this.scaleX,e*this.scaleY,f*this.scaleX,g*this.scaleY)},setScale:function(a,b){this.scaleX=a;this.scaleY=b}});
h5c3.ImageTools=h5c3.Base.extend("h5c3.ImageTools",{rotate:function(a,b,c,d){var e=document.createElement("canvas");e.width=b*d;e.height=c;for(var f=e.getContext("2d"),g=0;g<d;g++)f.save(),f.translate(g*b+b/2,c/2),f.rotate(360/d*g*(Math.PI/180)),f.drawImage(a,-(b/2),-(c/2)),f.restore();return new h5c3.CanvasImage(e)}},{});
h5c3.Scene=h5c3.Base.extend("h5c3.Scene",{},{name:null,layersByName:null,layers:null,activeLayers:null,paused:!1,active:!0,viewPort:null,ctx:null,viewPortCenter:null,init:function(a,b){this._super();if(this.name=$CHK(a,null))this.name=a;this.ctx=b?b:h5c3.device.game.ctx;this.layersByName=new h5c3.Hashtable;this.layers=new h5c3.LinkedList;this.activeLayers=new h5c3.LinkedList;this.viewPort=h5c3.Rect.create(0,0,0,0);this.viewPortCenter=h5c3.Point.create(0,0);this.setViewPort(0,0,h5c3.device.game.dim.w,
h5c3.device.game.dim.h);if(h5c3.device.started)this.onReady()},onReady:function(){for(var a=this.layers.first;a;)a.obj.onReady(),a=a.next()},onActivated:function(){},onDeactivated:function(){},onResize:function(a,b){this.setViewPort(this.viewPort.x,this.viewPort.y,a,b);for(var c=this.layers.first;c;)c.obj.onResize(a,b),c=c.next()},setViewPort:function(a,b,c,d){this.viewPort.x=a;this.viewPort.y=b;this.viewPort.w=c;this.viewPort.h=d;this.viewPortCenter.x=this.viewPort.w/2;this.viewPortCenter.y=this.viewPort.h/
2},getScreenRect:function(){return this.viewPort},sortLayers:function(){this.activeLayers.sort(function(a,b){return a.zIndex-b.zIndex})},onAction:function(a,b,c){},isActive:function(){return this.active},get:function(a){return this.layersByName.get(a)},addLayer:function(a){$VLD(a)||$_DBG_("Error: invalid layer");$VLD(a.name)||$_DBG_("Error: trying to add a layer that has no name (forget to call this._super in your layer init?)");this.layersByName.put(a.name,a);this.layers.add(a);this.activeLayers.add(a);
a.active=!0;a.scene=this;a.onAddedToScene();this.sortLayers();return a},removeLayer:function(a){this.layersByName.remove(a.name);this.layers.remove(a);this.activeLayers.remove(a);a.active=!1;a.scene=null;a.onRemovedFromScene()},setLayerActive:function(a){this.activeLayers.add(a);this.sortLayers();a.active=!0},setLayerInactive:function(a){this.activeLayers.remove(a);a.active=!1},toggleLayerActive:function(a){a.active?this.setLayerInactive(a):this.setLayerActive(a)},getFirstActiveLayer:function(){return this.activeLayers.first},
getFirstLayer:function(){return this.layers.first},startTime:0,process:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);for(var a=this.activeLayers.first;a;)a.obj.paused||(a.obj.process(),this.startTime=Date.now(),a.obj.draw(),h5c3.device.lastDrawMS+=Date.now()-this.startTime),a=a.next()},pause:function(){this.paused=!0;for(var a=this.activeLayers.first;a;)a.obj.pause(),a=a.next()},resume:function(){this.paused=!1;for(var a=this.activeLayers.first;a;)a.obj.resume(),
a=a.next()},reset:function(){for(var a=this.layers.first;a;)a.obj.reset(),a=a.next();this.layers.clear();this.activeLayers.clear()},entitiesUnderXY:function(a,b){for(var c=[],d=this.layers.first;d;)c.push(d.obj.entitiesUnderXY(a,b)),d=d.next()},loadFromTMX:function(a,b){var c=h5c3.device.parseXML(a.data),d=c.getElementsByTagName("map")[0],e=parseInt(d.getAttribute("tilewidth")),f=parseInt(d.getAttribute("tileheight")),g=c.getElementsByTagName("tileset")[0].getAttribute("name"),h=h5c3.loader.get(g);
$AST(h,"Unable to locate tile image resource: "+g+". It must match the tileset name in tiled.");for(var g=h5c3.loader.get(g).resource,g=new h5c3.SpriteSheet({image:g,frameWidth:e,frameHeight:f}),g=new h5c3.TileSet(g),h=c.getElementsByTagName("tile"),l=0;l<h.length;l++)for(var k=h[l],p=parseInt(k.getAttribute("id")),k=k.getElementsByTagName("properties")[0].getElementsByTagName("property"),q=0;q<k.length;q++){var m=k[q],r=m.getAttribute("name"),m=m.getAttribute("value");g.addProperty(p,r,m)}h=c.getElementsByTagName("layer");
for(l=0;l<h.length;l++)switch(d.getAttribute("orientation")){case "isometric":h5c3.IsoTileLayer.loadFromTMX(this,h[l],e,f,g);break;default:h5c3.TileLayer.loadFromTMX(this,h[l],e,f,g)}c=c.getElementsByTagName("objectgroup");for(d=0;d<c.length;d++)h5c3.EntityLayer.loadFromTMX(this,c[d],b)}});
h5c3.SceneFactory=h5c3.Factory.extend("h5c3.SceneFactory",{},{init:function(){this._super("Scene")},create:function(a){$CHK(a.name,!1);$CHK(a.sceneID,!1);if(!opions.name||!a.sceneID)throw"You must provide a name & sceneID.";$CHK(a.ctx,h5c3.game.ctx);if(this.exists(a.name))this.activateScene(a.name);else var b=new h5c3.Scene({name:"loading",sceneID:SceneID.LOADING});return this.add(a.name,b)}});
h5c3.IntroLayer=h5c3.EntityLayer.extend("h5c3.IntroLayer",{},{i2tmlabs:null,h5c3:null,splash:null,init:function(a){this._super(a);this.addSystem(new h5c3.systems.Render);this.addSystem(new h5c3.systems.Layout);this.addSystem(new h5c3.systems.Expiration);this.addSystem(new h5c3.systems.Effects);this.show("i2tm")},show:function(a){try{"i2tm"===a?(this.sheetPublisher=new h5c3.SpriteSheet({image:h5c3.loader.get("publisher").resource,frameWidth:1920,frameHeight:1080}),this.i2tmlabs=this.createEntity("i2tmlabs"),
h5c3.soundFactory.play("i2tm",{volume:0.5,loop:!1})):"h5c3"===a&&(this.sheetH5C3=new h5c3.SpriteSheet({image:h5c3.loader.get("h5c3").resource,frameWidth:1920,frameHeight:1080}),this.h5c3=this.createEntity("h5c3"))}catch(b){$_DBG_(b)}},onEntityRemoved:function(a){$_DBG_(a+" has been removed.")},createEntity:function(a){var b=h5c3.Entity.create(this);b.addTag(a);switch(a){case "i2tmlabs":b.addComponent(h5c3.components.Sprite.create({spriteSheet:this.sheetPublisher}));b.addComponent(h5c3.components.Spatial.create({w:this.sheetPublisher.frameWidth,
h:this.sheetPublisher.frameHeight}));b.onRemoved=function(){h5c3.device.game.obj.publisherScene.layer.show("h5c3")};break;case "h5c3":b.addComponent(h5c3.components.Sprite.create({spriteSheet:this.sheetH5C3})),b.addComponent(h5c3.components.Spatial.create({w:this.sheetH5C3.frameWidth,h:this.sheetH5C3.frameHeight})),b.onRemoved=function(){h5c3.device.game.obj.setScene(h5c3.device.game.obj.publisherScene,SceneID.MAINMENU)}}b.addComponent(h5c3.components.Layout.create({vertical:"center",horizontal:"center"}));
b.addComponent(h5c3.components.Expiry.create({lifetime:1E3}));return b}});
h5c3.IntroScene=h5c3.Scene.extend("h5c3.IntroScene",{},{layer:null,init:function(){this._super("Intro Scene");this.layer=new h5c3.IntroLayer({scene:this,name:"introLayer",worldSizeX:this.ctx.canvas.width,worldSizeY:this.ctx.canvas.height});this.addLayer(this.layer);h5c3.device.input.bindAction(this,"skip","SPACE");h5c3.device.input.bindAction(this,"skip","MOUSE_CLICK");h5c3.device.input.bindAction(this,"skip","TOUCH")},onAction:function(a,b,c){"skip"===a&&h5c3.device.game.obj.setScene(this,SceneID.MAINMENU)}});
